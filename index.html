<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëª¸í´ê¸°ìƒí™œìš´ë™ ì—°ì‹ ë‚´ ì¶œì„ë¶€ (6ê°œì›” ì¶”ì´ ê·¸ë˜í”„)</title>

    <!-- SEO ë° ê³µìœ  ìµœì í™” (Open Graph) -->
    <meta name="description" content="ëª¸í´ê¸°ìƒí™œìš´ë™ ì—°ì‹ ë‚´ ì§€ë¶€ì˜ ìŠ¤ë§ˆíŠ¸í•œ QR ì¶œì„ ê´€ë¦¬ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.">
    <meta property="og:title" content="ëª¸í´ê¸°ìƒí™œìš´ë™ ì—°ì‹ ë‚´ ì¶œì„ë¶€">
    <meta property="og:description" content="QR ì½”ë“œì™€ ëª…ë‹¨ ì„ íƒì„ í†µí•œ ê°„í¸í•œ ì¶œì„ ì²´í¬">
    <meta property="og:type" content="website">
    <meta property="og:image" content="app-icon.png">
    <link rel="icon" href="app-icon.png">

    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.11.1/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Chart.js (ê·¸ë˜í”„ìš©) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js DataLabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* [SENIOR FRIENDLY] ê³ ëŒ€ë¹„ ë° ê°€ë…ì„± í–¥ìƒ ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
            font-size: 16px; /* ê¸°ë³¸ í°íŠ¸ í¬ê¸° ìƒí–¥ */
        }
        .app-container { max-width: 1024px; margin: 0 auto; background-color: hsl(var(--b1)); min-height: 100vh; position: relative; padding-bottom: 80px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        /* í˜ì´ì§€ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ */
        .page { display: none; padding: 20px; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .page.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* [NEW] ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeInUp {
            opacity: 0; /* ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ ì „ ìˆ¨ê¹€ */
            animation-name: fadeInUp;
            animation-duration: 0.5s;
            animation-fill-mode: forwards; /* ì• ë‹ˆë©”ì´ì…˜ í›„ ìƒíƒœ ìœ ì§€ */
            animation-timing-function: ease-out;
        }

        /* ì¸ì‡„ ëª¨ë“œ ì„¤ì • */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- Mode Selection & Login Section -->
    <section id="start-screen" class="absolute inset-0 bg-gray-100 z-50 flex flex-col justify-center items-center p-6" aria-labelledby="mode-selection-title">
        <div id="mode-selection" class="w-full max-w-lg text-center">
            <h1 id="mode-selection-title" class="text-4xl font-bold text-indigo-600 mb-10">ëª¸í´ê¸°ìƒí™œìš´ë™<br>ì—°ì‹ ë‚´ ì¶œì„ë¶€</h1>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <button onclick="enterMemberMode()" class="btn h-auto flex-col p-10 bg-base-100 border-2 border-primary rounded-3xl shadow-lg hover:bg-base-200 transition-all duration-300 group">
                    <i class="fas fa-user-check text-4xl text-indigo-500 mb-3" aria-hidden="true"></i>
                    <p class="text-3xl font-bold text-gray-800">íšŒì› ì¶œì„í•˜ê¸°</p>
                    <p class="text-base text-gray-500 mt-2">ë¹„ë°€ë²ˆí˜¸ ì—†ì´ ì…ì¥</p>
                </button>
                <button onclick="showAdminLogin()" class="btn h-auto flex-col p-10 bg-neutral text-neutral-content rounded-3xl shadow-lg hover:bg-neutral-focus transition-all duration-300">
                    <i class="fas fa-user-shield text-4xl mb-3" aria-hidden="true"></i>
                    <p class="text-3xl font-bold">ê´€ë¦¬ì ì „ìš©</p>
                    <p class="text-base text-gray-400 mt-2">ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í›„ ì…ì¥</p>
                </button>
            </div>
        </div>

        <div id="login-form" class="w-full max-w-xs text-center hidden">
            <button onclick="backToModeSelection()" class="mb-8 text-gray-400 hover:text-gray-600" aria-label="ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°">
                <i class="fas fa-arrow-left mr-2" aria-hidden="true"></i>ë’¤ë¡œê°€ê¸°
            </button>
            <i class="fas fa-lock text-4xl text-gray-400 mb-4" aria-hidden="true"></i>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
            <p class="text-base text-gray-500 mb-6">ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <div id="login-input-wrapper" class="form-control">
                <label class="input input-bordered flex items-center gap-2 mb-4">
                    <input type="password" id="admin-password" class="grow text-center" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeyup="if(event.key==='Enter') handleLogin()" autocomplete="current-password" />
                    <label class="swap">
                        <input type="checkbox" onchange="window.togglePasswordVisibility(this)" />
                        <i class="swap-on fas fa-eye-slash"></i>
                        <i class="swap-off fas fa-eye"></i>
                    </label>
                </label>
            </div>
            <div id="recovery-input-wrapper" class="hidden form-control">
                <input type="text" id="recovery-master-key" class="input input-bordered input-warning w-full text-center" placeholder="ë³µêµ¬ ì½”ë“œ ì…ë ¥">
                <p class="text-xs text-orange-600 mb-4">ë§ˆìŠ¤í„° ë³µêµ¬ ì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ ë¹„ë°€ë²ˆí˜¸ê°€ '1234'ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</p>
            </div>
            <button id="btn-admin-login" onclick="handleLogin()" class="btn btn-primary w-full mb-4">ë¡œê·¸ì¸</button>
            <button id="btn-admin-recovery" onclick="handleMasterKeyReset()" class="btn btn-warning w-full mb-4 hidden">ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”</button>
            <button onclick="toggleRecoveryMode()" id="link-forgot-pw" class="link link-primary text-xs">ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?</button>

            <div class="mt-8 border-t pt-4 border-dashed border-red-300">
                <h4 class="text-sm font-bold text-red-500 mb-2">[ì„ì‹œ] í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±</h4>
                <p class="text-xs text-gray-500 mb-2">ì„ íƒí•œ ì›”ì— ëŒ€í•´ ëœë¤ ì¶œì„ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (ê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)</p>
                <input type="month" id="test-data-month" class="w-full p-2 border rounded mb-2 bg-gray-50">
                <button onclick="generateTestData()" class="w-full py-2 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600">ë°ì´í„° ìƒì„± ì‹¤í–‰</button>
            </div>
        </div>
    </section>

    <!-- Main App Wrapper -->
    <main id="app-main-content" class="hidden">
        <!-- Header -->
        <header class="bg-primary text-primary-content p-4 sticky top-0 z-40 shadow-md flex justify-between items-center no-print">
            <h1 class="text-xl font-bold"><i class="fas fa-check-circle mr-2" aria-hidden="true"></i>ì—°ì‹ ë‚´ ì¶œì„ë¶€</h1>
            <div class="flex gap-2">
                <button id="btn-exit-member-mode" onclick="exitMemberMode()" class="hidden btn btn-error btn-md">ì¶œì„ ì¢…ë£Œ</button>
                <button onclick="resetData()" class="admin-only btn btn-error btn-sm">ì´ˆê¸°í™”</button>
                <button id="btn-exit-admin-mode" onclick="exitMemberMode()" class="admin-only btn btn-ghost btn-md">ë’¤ë¡œê°€ê¸°</button>
            </div>
        </header>

        <!-- Page: Member Attendance (New) -->
        <section id="page-member-attendance" class="page">
            <div class="card bg-base-100 shadow-xl text-center">
              <div class="card-body">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 leading-relaxed">í—ˆë¦¬ëŠ” ì„¸ìš°ê³ ,<br>ê°€ìŠ´ì€ í´ê³ ,<br>ê³ ê°œëŠ” ë“¤ì!</h2>
                <p id="current-session-info" class="text-indigo-600 font-bold text-xl mb-6">í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ìˆ˜ì—…ì„ ì°¾ëŠ” ì¤‘...</p>

                <!-- [NEW] Date & Session Selection for Member Mode -->
                <div class="grid grid-cols-2 gap-2 sm:gap-4 mb-8 max-w-md mx-auto px-2">
                    <div class="text-left">
                        <label for="member-mode-date" class="block text-xs sm:text-sm font-bold text-gray-500 mb-2">ì¶œì„ ë‚ ì§œ</label>
                        <input type="date" id="member-mode-date" class="input input-bordered w-full" onchange="updateMemberModeSessionOptions()">
                    </div>
                    <div class="text-left">
                        <label for="member-mode-session" class="block text-xs sm:text-sm font-bold text-gray-500 mb-2">ìˆ˜ì—…(ì°¨ìˆ˜) ì„ íƒ</label>
                        <div class="join w-full">
                            <select id="member-mode-session" class="select select-bordered join-item flex-1"></select>
                            <button id="btn-sync-member" onclick="syncMemberModeToNow()" class="btn join-item" title="í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ìˆ˜ì—… ê°±ì‹ ">
                                <i class="fas fa-sync-alt" id="icon-sync-member"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="relative mb-8">
                    <label for="member-search-input" class="sr-only">íšŒì› ì´ë¦„ ê²€ìƒ‰</label>
                    <input type="text" id="member-search-input" oninput="renderMemberGrid(this.value)" placeholder="ì´ë¦„ ë˜ëŠ” ì´ˆì„± ê²€ìƒ‰ (ì˜ˆ: ã„±ã„·ã…)" 
                           class="input input-bordered input-lg w-full text-2xl">
                    <i class="fas fa-search absolute right-5 top-6 text-gray-300 text-2xl" aria-hidden="true"></i>
                </div>

                <div id="member-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-[50vh] overflow-y-auto p-2">
                    <!-- Member buttons will be rendered here -->
                </div>
            </div>
            </div>
        </section>

        <!-- Page 1: Home (QR & Tools) -->
        <section id="page-home" class="page">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title"><i class="fas fa-qrcode mr-2" aria-hidden="true"></i>QR ì½”ë“œ ê´€ë¦¬</h2>
                    <p>ê°•ì˜ì‹¤ ë¶€ì°©ìš© QR ì½”ë“œë¥¼ ì¸ì‡„í•˜ì„¸ìš”.</p>
                    <div class="card-actions justify-end">
                        <button onclick="openQRPrintModal()" class="btn btn-neutral w-full"><i class="fas fa-print mr-2"></i>QR ì½”ë“œ ëª©ë¡ ë³´ê¸°</button>
                    </div>
                </div>
            </div>

            <div class="card bg-base-100 shadow-xl mt-5">
                <div class="card-body">
                    <h2 class="card-title"><i class="fas fa-tools mr-2" aria-hidden="true"></i>ê´€ë¦¬ì ë„êµ¬</h2>
                    <button onclick="openPaperInputModal()" class="btn btn-success text-white">
                        <i class="fas fa-edit mr-2"></i>ì¢…ì´ ëª…ë¶€ ì…ë ¥ (í…ìŠ¤íŠ¸)
                    </button>
                    <p class="text-xs text-gray-400 mt-1">
                        * ì´ë¦„ë§Œ ì…ë ¥í•˜ë©´ ìë™ ê°€ì…/ì¶œì„ ì²˜ë¦¬ë©ë‹ˆë‹¤.<br>
                        * ë™ëª…ì´ì¸ì€ <strong>ì´ë¦„ ë²ˆí˜¸ë’·ìë¦¬</strong> (ì˜ˆ: ê¹€ì² ìˆ˜ 1234)
                    </p>
                    <button onclick="openPasswordChangeModal()" class="btn btn-ghost mt-4">
                        <i class="fas fa-key mr-2"></i>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                    </button>
                </div>
            </div>
            
            <!-- [NEW] Instructor Management Card -->
            <div class="card bg-base-100 shadow-xl mt-5 admin-only">
                <div class="card-body">
                    <h2 class="card-title"><i class="fas fa-chalkboard-teacher mr-2"></i>ë‹´ë‹¹ ì‚¬ë²” ê´€ë¦¬</h2>
                    <p class="text-xs">* ê° ìˆ˜ì—…(ì°¨ìˆ˜)ë³„ ë‹´ë‹¹ ì‚¬ë²”ì„ ë“±ë¡/ìˆ˜ì •/ì‚­ì œí•©ë‹ˆë‹¤.</p>
                    <ul id="instructor-management-list" class="divide-y divide-gray-100">
                        <!-- Instructor list will be rendered here by JS -->
                    </ul>
                </div>
            </div>
            
            <div class="text-center text-xs text-gray-400 mt-4">
                í˜„ì¬ ì ‘ì† ì£¼ì†Œ:<br>
                <span id="current-url" class="text-indigo-500 break-all"></span>
            </div>
        </section>

        <!-- Page 2: Members -->
        <section id="page-members" class="page">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">íšŒì› ë“±ë¡</h2>
                    <div class="join w-full">
                        <input type="text" id="new-member-name" placeholder="ì´ë¦„ (í•„ìˆ˜)" class="input input-bordered join-item flex-1">
                        <input type="tel" id="new-member-phone" placeholder="ë’·ë²ˆí˜¸ (ì„ íƒ)" class="input input-bordered join-item w-1/3">
                    </div>
                    <div class="card-actions justify-end">
                        <button onclick="addMember()" class="btn btn-primary w-full">ë“±ë¡í•˜ê¸°</button>
                    </div>
                </div>
            </div>
            <div class="card bg-base-100 shadow-xl mt-5">
                <div class="card-body">
                    <h2 class="card-title">íšŒì› ëª©ë¡ <span id="member-count" class="text-base text-indigo-600 font-normal"></span></h2>
                    <p class="text-xs">* ì´ë¦„ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ì´ë ¥ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <ul id="member-list" class="divide-y divide-gray-100"></ul>
                </div>
            </div>
        </section>

        <!-- Page 3: Reports (Tables & Chart) -->
        <section id="page-reports" class="page">
            <!-- Month Filter -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <h2 class="text-2xl font-bold text-gray-800">ë¦¬í¬íŠ¸ ë° í†µê³„</h2>
                <input type="month" id="report-month-filter" class="input input-bordered w-full sm:w-auto font-bold text-lg">
            </div>
        
            <!-- Report Tabs -->
            <div id="report-tabs-wrapper" class="mt-6"></div>

            <!-- Report Contents -->
            <div id="report-contents" class="mt-6">
                <!-- íƒ­ 1: ëŒ€ì‹œë³´ë“œ -->
                <div id="report-content-dashboard" class="report-content-panel space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="card lg:col-span-1">
                            <h3 class="font-bold text-lg mb-2">ì›”ê°„ ì´ ì¶œì„ (UV)</h3>
                            <p id="report-monthly-total" class="text-4xl font-bold text-indigo-600">0ëª…</p>
                            <p class="text-sm text-gray-500">í•´ë‹¹ ì›”ì— í•œ ë²ˆ ì´ìƒ ì¶œì„í•œ íšŒì› ìˆ˜</p>
                        </div>
                        <div class="card bg-base-100 shadow-xl lg:col-span-2">
                            <h3 class="font-bold text-lg mb-2">ì¶œì„ ì¸ì› ì¶”ì´ (ìµœê·¼ 6ê°œì›”)</h3>
                            <div class="h-48">
                                <canvas id="attendance-trend-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- íƒ­ 2: ì°¨ìˆ˜ë³„ ì£¼ê°„ ì¶œì„ -->
                <div id="report-content-class-weekly" class="report-content-panel space-y-6">
                    <div class="card bg-base-100 shadow-xl">
                        <h3 class="font-bold text-lg mb-4">ì°¨ìˆ˜ë³„ ì£¼ê°„ ì¶œì„</h3>
                        <p class="text-sm text-gray-500 mb-4">ì„ íƒí•œ ì›”ì˜ ê° ìˆ˜ì—…(ì°¨ìˆ˜)ë³„ ì£¼ì°¨ ì¶œì„ í˜„í™©ì…ë‹ˆë‹¤. ìˆ«ìë¥¼ í´ë¦­í•˜ë©´ ì°¸ì„ì ëª…ë‹¨ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        <div id="report-class-weekly-attendance" class="overflow-x-auto"></div>
                    </div>
                </div>
                <!-- íƒ­ 3: ê°œì¸ë³„ ì£¼ê°„ ì¶œì„ -->
                <div id="report-content-member-weekly" class="report-content-panel space-y-6">
                    <div class="card bg-base-100 shadow-xl">
                        <h3 class="font-bold text-lg mb-4">ê°œì¸ë³„ ì£¼ê°„ ì¶œì„</h3>
                        <p class="text-sm text-gray-500 mb-4">ì„ íƒí•œ ì›”ì˜ íšŒì›ë³„ ì£¼ì°¨ ì¶œì„ í˜„í™©ì…ë‹ˆë‹¤.</p>
                        <div id="report-member-weekly-attendance" class="overflow-x-auto"></div>
                    </div>
                </div>
                <!-- íƒ­ 4: ì¶œì„ ìˆœìœ„ -->
                <div id="report-content-member-rank" class="report-content-panel space-y-6">
                    <div class="card bg-base-100 shadow-xl">
                        <h3 class="font-bold text-lg mb-4">ì¶œì„ ìˆœìœ„</h3>
                        <p class="text-sm text-gray-500 mb-4">ì„ íƒí•œ ì›”ì˜ íšŒì›ë³„ ì´ ì¶œì„ íšŸìˆ˜ ìˆœìœ„ì…ë‹ˆë‹¤.</p>
                        <div id="report-member-ranking" class="overflow-x-auto"></div>
                    </div>
                </div>
                <!-- íƒ­ 5: ìˆ˜ì—… ì°¸ì—¬ í˜„í™© -->
                <div id="report-content-class-popularity" class="report-content-panel space-y-6">
                    <div class="card bg-base-100 shadow-xl">
                        <h3 class="font-bold text-lg mb-4">ìˆ˜ì—…(ì°¨ìˆ˜)ë³„ ì°¸ì—¬ í˜„í™©</h3>
                        <p class="text-sm text-gray-500 mb-4">ì„ íƒí•œ ì›”ì— ì°¸ì—¬ ì¸ì›ì´ ë§ì€ ìˆ˜ì—… ìˆœìœ„ì…ë‹ˆë‹¤.</p>
                        <div id="report-class-popularity" class="overflow-x-auto"></div>
                    </div>
                </div>
                <!-- íƒ­ 6: ì‹ ê·œ íšŒì› -->
                <div id="report-content-new-member-trend" class="report-content-panel space-y-6">
                    <div class="card bg-base-100 shadow-xl">
                        <h3 class="font-bold text-lg mb-4">ì›”ë³„ ì‹ ê·œ íšŒì› ìœ ì… í˜„í™©</h3>
                        <p class="text-sm text-gray-500 mb-4">ìµœê·¼ 6ê°œì›”ê°„ ìƒˆë¡œ ê°€ì…í•œ íšŒì› ìˆ˜ ì¶”ì´ì…ë‹ˆë‹¤.</p>
                        <div class="h-72 mb-4">
                            <canvas id="new-members-chart"></canvas>
                        </div>
                        <div class="alert alert-warning text-xs">â€» ì°¸ê³ : ì‹œìŠ¤í…œ ë„ì… ì²« ë‹¬ì—ëŠ” ê¸°ì¡´ íšŒì›ì´ ëª¨ë‘ ì‹ ê·œë¡œ ì§‘ê³„ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
                    </div>
                </div>
                <!-- íƒ­ 7: ì¥ê¸° ë¯¸ì¶œì„ -->
                <div id="report-content-inactive-members" class="report-content-panel space-y-6">
                    <div class="card bg-base-100 shadow-xl">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-2">
                            <div>
                                <h3 class="font-bold text-lg">ì¥ê¸° ë¯¸ì¶œì„ íšŒì›</h3>
                                <p class="text-sm text-gray-500">ì„¤ì •í•œ ê¸°ê°„ ë™ì•ˆ ì¶œì„ ê¸°ë¡ì´ ì—†ëŠ” íšŒì› ëª©ë¡ì…ë‹ˆë‹¤.</p>
                            </div>
                            <select id="inactive-period-selector" class="p-2 border rounded text-sm self-start sm:self-center">
                                <option value="30">ìµœê·¼ 30ì¼</option>
                                <option value="60" selected>ìµœê·¼ 60ì¼</option>
                                <option value="90">ìµœê·¼ 90ì¼</option>
                            </select>
                        </div>
                        <div id="report-inactive-members-list" class="overflow-x-auto"></div>
                    </div>
                </div>
            </div>
        
        </section>

        <!-- Navigation Bar -->
        <div class="btm-nav no-print admin-only">
            <button class="active" onclick="switchPage(this, 'home')">
                <i class="fas fa-home" aria-hidden="true"></i><span>í™ˆ</span>
            </button>
            <button onclick="switchPage(this, 'members')">
                <i class="fas fa-users" aria-hidden="true"></i><span>íšŒì›ê´€ë¦¬</span>
            </button>
            <button onclick="switchPage(this, 'reports')">
                <i class="fas fa-chart-bar" aria-hidden="true"></i><span>ë¦¬í¬íŠ¸</span>
            </button>
        </div>
    </main>
</div>

<!-- Modal: QR Print View -->
<dialog id="qr-print-modal" class="modal">
    <div class="modal-box w-11/12 max-w-2xl">
        <div id="print-area">
            <div class="flex justify-between items-center mb-6 no-print">
                <h2 class="text-2xl font-bold">ì¸ì‡„ìš© QR ì½”ë“œ</h2>
                <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost"><i class="fas fa-times"></i></button></form>
            </div>
            <div class="no-print mb-4 text-center">
                <button onclick="window.print()" class="btn btn-info text-white"><i class="fas fa-print mr-2"></i>ì¸ì‡„í•˜ê¸°</button>
                <div class="alert alert-warning text-xs mt-2">â€» ì£¼ì˜: ì´ QR ì½”ë“œëŠ” í˜„ì¬ ì›¹ì‚¬ì´íŠ¸ ì£¼ì†Œ ê¸°ë°˜ì…ë‹ˆë‹¤. ì„œë²„ ì£¼ì†Œê°€ ë°”ë€Œë©´ ë‹¤ì‹œ ì¶œë ¥í•´ì•¼ í•©ë‹ˆë‹¤.</div>
            </div>
            <div id="static-qr-list" class="grid grid-cols-1 md:grid-cols-2 gap-8 text-center"></div>
        </div>
    </div>
</dialog>

<!-- Modal: Paper Input (Text Area) -->
<dialog id="paper-input-modal" class="modal">
    <div class="modal-box w-11/12 max-w-md">
        <h3 class="text-2xl font-bold mb-4 text-green-700"><i class="fas fa-edit mr-2"></i>ì¢…ì´ ëª…ë¶€ ì…ë ¥</h3>
        <div class="mb-3">
            <label class="block text-sm font-bold text-gray-500 mb-2">1. ë‚ ì§œ ì„ íƒ</label>
            <input type="date" id="paper-date" class="input input-bordered w-full font-bold text-lg" onchange="updateSessionOptions()">
        </div>

        <div class="mb-3">
            <label class="block text-sm font-bold text-gray-500 mb-2">2. ìˆ˜ì—…(ì°¨ìˆ˜) ì„ íƒ</label>
            <div class="join w-full">
                <select id="paper-session-select" class="select select-bordered join-item flex-1 font-bold">
                    <!-- JSë¡œ ì˜µì…˜ ì±„ì›€ -->
                </select>
                <button onclick="syncPaperInputToNow()" class="btn join-item" title="í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ë§ì¶¤">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-bold text-gray-500 mb-2">3. ëª…ë‹¨ ì…ë ¥ (ì´ë¦„ë§Œ ì…ë ¥ ê°€ëŠ¥)</label>
            <textarea id="paper-text-area" class="textarea textarea-bordered w-full h-40 font-mono" placeholder="ê¹€ì² ìˆ˜&#13;&#10;ì´ì˜í¬&#13;&#10;ë°•ë¯¼ìˆ˜ 5678"></textarea>
            <p class="text-xs text-indigo-500 mt-1">* ì—†ëŠ” íšŒì›ì€ ìë™ ê°€ì…ë©ë‹ˆë‹¤.</p>
        </div>
        <div class="modal-action">
            <button onclick="processPaperInput()" class="btn btn-success text-white">ì¼ê´„ ì¶œì„ ì²˜ë¦¬</button>
            <form method="dialog"><button class="btn">ë‹«ê¸°</button></form>
        </div>
    </div>
</dialog>

<!-- Modal: User Attendance Check (QR Scan Result) -->
<dialog id="user-check-modal" class="modal">
    <div class="modal-box w-11/12 max-w-md text-center">
        <h3 class="text-3xl font-bold mb-6 text-indigo-600">ì¶œì„ ì²´í¬</h3>
        <!-- Date & Session Adjustment -->
        <div class="grid grid-cols-2 gap-2 mb-4">
            <div class="text-left">
                <label class="block text-sm font-bold text-gray-500 mb-2">ì¶œì„ ë‚ ì§œ</label>
                <input type="date" id="check-date" class="input input-bordered w-full" onchange="updateCheckSessionOptions()">
            </div>
            <div class="text-left">
                <label class="block text-sm font-bold text-gray-500 mb-2">ìˆ˜ì—…(ì°¨ìˆ˜) ì„ íƒ</label>
                <select id="check-session-select" class="select select-bordered w-full"></select>
            </div>
        </div>

        <!-- Manual Input (Default View) -->
        <div id="check-manual-wrapper">
            <input type="text" id="check-manual-name" placeholder="ì´ë¦„ ì…ë ¥" class="input input-bordered input-lg w-full mb-3 text-center">
            <input type="tel" id="check-manual-phone" placeholder="ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ (ì„ íƒ)" class="input input-bordered w-full mb-4 text-center">
            <button onclick="toggleCheckMode('existing')" class="btn btn-ghost w-full mb-4">
                ğŸ” ì „ì²´ ëª…ë‹¨ì—ì„œ ì„ íƒí•˜ê¸°
            </button>
        </div>

        <!-- Existing Member Select (Hidden by default) -->
        <div id="check-existing-wrapper" class="hidden">
            <select id="check-user-select" class="select select-bordered select-lg w-full mb-4 h-20">
                <option value="">â¬‡ï¸ ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ ì´ë¦„ ì„ íƒ</option>
            </select>
            <button onclick="toggleCheckMode('manual')" class="btn btn-ghost w-full mb-4">âŒ¨ï¸ ì§ì ‘ ì…ë ¥ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>

        <div class="modal-action mt-4 justify-center">
            <button onclick="confirmAttendance()" class="btn btn-primary btn-lg">âœ… ì¶œì„ í™•ì¸</button>
            <form method="dialog"><button class="btn btn-ghost">ì·¨ì†Œ</button></form>
        </div>
    </div>
</dialog>

<!-- Modal: Member History -->
<dialog id="history-modal" class="modal">
    <div class="modal-box w-11/12 max-w-sm max-h-[80vh] flex flex-col">
        <h3 class="text-2xl font-bold mb-1 text-indigo-700" id="history-member-name">íšŒì› ì´ë¦„</h3>
        <p class="text-xs text-gray-500 mb-4">ìƒì„¸ ì¶œì„ ì´ë ¥ (ìµœì‹ ìˆœ)</p>
        <div class="overflow-y-auto flex-1 border-t border-gray-100 pt-2">
            <ul id="history-list" class="text-base space-y-3">
                <!-- History items will go here -->
            </ul>
        </div>
        <div class="modal-action mt-4">
            <form method="dialog"><button class="btn w-full">ë‹«ê¸°</button></form>
        </div>
    </div>
</dialog>

<!-- Modal: Change Password -->
<dialog id="password-change-modal" class="modal">
    <div class="modal-box w-11/12 max-w-xs">
        <h3 class="text-xl font-bold mb-4 text-gray-800">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
        <input type="password" id="current-password" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" class="input input-bordered w-full mb-2">
        <input type="password" id="new-password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" class="input input-bordered w-full mb-2">
        <input type="password" id="confirm-password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" class="input input-bordered w-full mb-4">
        <button onclick="changePassword()" class="btn btn-primary w-full">ë³€ê²½í•˜ê¸°</button>
        <div class="alert alert-warning mt-6 text-left">
            <div class="text-xs">
                <h3 class="font-bold uppercase">ë§ˆìŠ¤í„° ë³µêµ¬ ì½”ë“œ (ë¶„ì‹¤ ëŒ€ë¹„)</h3>
                <p id="master-key-display" class="font-mono font-bold break-all select-all"></p>
                <p class="text-[9px]">* ë¹„ë°€ë²ˆí˜¸ ë¶„ì‹¤ ì‹œ ì´ ì½”ë“œë¡œ ì´ˆê¸°í™”ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë”°ë¡œ ê¸°ë¡í•´ ë‘ì„¸ìš”.</p>
            </div>
        </div>
        <div class="modal-action mt-2">
            <form method="dialog"><button class="btn btn-sm btn-ghost">ë‹«ê¸°</button></form>
        </div>
    </div>
</dialog>

<!-- Modal: Session Attendees -->
<dialog id="session-attendees-modal" class="modal">
    <div class="modal-box w-11/12 max-w-sm max-h-[80vh] flex flex-col">
        <h3 class="text-xl font-bold mb-1 text-green-700" id="session-attendees-title">ì„¸ì…˜ ì°¸ì„ì ëª…ë‹¨</h3>
        <p class="text-xs text-gray-500 mb-4" id="session-attendees-subtitle">ì›”ê°„ ì´ ì°¸ì„ì (ì¤‘ë³µ ì œì™¸)</p>
        <div class="overflow-y-auto flex-1 border-t border-gray-100 pt-2">
            <ul id="session-attendees-list" class="text-sm space-y-2">
                <!-- Attendee names will go here -->
            </ul>
        </div>
        <div class="modal-action mt-4">
            <form method="dialog"><button class="btn w-full">ë‹«ê¸°</button></form>
        </div>
    </div>
</dialog>

<!-- Modal: New Members List -->
<dialog id="new-members-modal" class="modal">
    <div class="modal-box w-11/12 max-w-sm max-h-[80vh] flex flex-col">
        <h3 class="text-xl font-bold mb-1 text-green-700" id="new-members-title">ì‹ ê·œ íšŒì› ëª…ë‹¨</h3>
        <p class="text-xs text-gray-500 mb-4" id="new-members-subtitle">í•´ë‹¹ ì›”ì— ê°€ì…í•œ íšŒì›</p>
        <div class="overflow-y-auto flex-1 border-t border-gray-100 pt-2">
            <ul id="new-members-list" class="text-sm space-y-2">
                <!-- New member names will go here -->
            </ul>
        </div>
        <div class="modal-action mt-4">
            <form method="dialog"><button class="btn w-full">ë‹«ê¸°</button></form>
        </div>
    </div>
</dialog>

<!-- Modal: Password Confirmation for Sensitive Actions -->
<dialog id="password-confirm-modal" class="modal">
    <div class="modal-box w-11/12 max-w-xs text-center">
        <h3 class="text-xl font-bold mb-2 text-red-600">ğŸ” ë³´ì•ˆ í™•ì¸</h3>
        <p class="text-sm text-gray-500 mb-4">ë¯¼ê°í•œ ì‘ì—…ì„ ìœ„í•´<br>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
        <input type="password" id="confirm-pw-input" class="input input-bordered w-full text-center" placeholder="â€¢â€¢â€¢â€¢" onkeyup="if(event.key==='Enter') handlePasswordConfirm()">
        <div class="modal-action mt-4">
            <button onclick="handlePasswordConfirm()" class="btn btn-primary">í™•ì¸</button>
            <form method="dialog"><button class="btn">ì·¨ì†Œ</button></form>
        </div>
    </div>
</dialog>

<!-- Modal: Final Reset Confirmation -->
<dialog id="reset-confirm-modal" class="modal">
    <div class="modal-box w-11/12 max-w-sm text-center border-4 border-error">
        <div class="w-20 h-20 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce">
            <i class="fas fa-exclamation-triangle text-4xl"></i>
        </div>
        <h3 class="text-2xl font-bold mb-2 text-red-600">ìµœì¢… ê²½ê³ : ë°ì´í„° ì´ˆê¸°í™”</h3>
        <p class="text-sm text-gray-600 mb-6 leading-relaxed">
            ëª¨ë“  íšŒì› ì •ë³´ì™€ ì¶œì„ ê¸°ë¡ì´ <span class="font-bold text-red-600 underline">ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œ</span>ë©ë‹ˆë‹¤.<br>
            ì´ ì‘ì—…ì€ ì ˆëŒ€ë¡œ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </p>
        
        <div class="mb-6">
            <p class="text-xs font-bold text-gray-400 mb-2 uppercase">í™•ì¸ì„ ìœ„í•´ ì•„ë˜ì— "ì´ˆê¸°í™”"ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            <input type="text" id="reset-confirm-input" class="input input-bordered input-error w-full text-center" placeholder="ì´ˆê¸°í™”" onkeyup="if(event.key==='Enter') handleResetFinalConfirm()">
        </div>

        <div class="modal-action flex-col gap-2">
            <button onclick="handleResetFinalConfirm()" class="btn btn-error w-full">ì „ì²´ ì‚­ì œ ì‹¤í–‰</button>
            <form method="dialog"><button class="btn w-full">ì·¨ì†Œ</button></form>
        </div>
    </div>
</dialog>

<!-- [NEW] daisyUI Toast Container -->
<div id="toast-container" class="toast toast-bottom toast-center z-[100]">
    <!-- Toast alerts will be dynamically added here -->
</div>

<script type="module">
    // --- 0. Firebase Setup ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, writeBatch, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // TODO: Firebase Consoleì—ì„œ ë°œê¸‰ë°›ì€ ì„¤ì •ê°’ì„ ì•„ë˜ì— ì…ë ¥í•´ì£¼ì„¸ìš”.
    const firebaseConfig = {
        apiKey: "AIzaSyBeO3VsRM8x7pY9A5tktrUDIZPfCMKGZfQ",
        authDomain: "smart-attendance-964dc.firebaseapp.com",
        projectId: "smart-attendance-964dc",
        storageBucket: "smart-attendance-964dc.firebasestorage.app",
        messagingSenderId: "409196393524",
        appId: "1:409196393524:web:f705254e8e62c415488661"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- 1. Configuration ---
    // [CHANGED] Use localStorage for password persistence. Default is '1234'.
    const initAdminPw = () => {
        const pw = localStorage.getItem('adminPassword');
        if (!pw || pw.trim() === "" || pw === 'undefined' || pw === 'null') {
            localStorage.setItem('adminPassword', '1234');
        }
    };
    initAdminPw();
    
    // Register ChartDataLabels plugin globally
    Chart.register(ChartDataLabels);

    window.DAYS = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
    const DAYS = window.DAYS;

    const TIMES = [
        { id: "AM", name: "ì˜¤ì „ë°˜", start: 6, end: 12 },
        { id: "PM", name: "ì˜¤í›„ë°˜", start: 12, end: 18 },
        { id: "EVE", name: "ì €ë…ë°˜", start: 18, end: 24 }
    ];
    const SESSIONS = [];
    window.SESSIONS = SESSIONS;

    // ì›”~ê¸ˆ ìƒì„±
    for(let d=1; d<=5; d++) {
        TIMES.forEach(t => {
            SESSIONS.push({ code: `D${d}_${t.id}`, name: `${DAYS[d]}ìš”ì¼ ${t.name}`, day: d, start: t.start, end: t.end });
        });
    }
    // í† ìš”ì¼ ì˜¤í›„ë°˜ ì¶”ê°€
    SESSIONS.push({ code: "D6_PM", name: "í† ìš”ì¼ ì˜¤í›„ë°˜", day: 6, start: 12, end: 18 });

    // --- Helper: Get Today String (YYYY-MM-DD) ---
    window.getTodayStr = () => {
        const now = new Date();
        const yyyy = now.getFullYear();
        const m = now.getMonth() + 1;
        const d = now.getDate();
        return yyyy + '-' + (m < 10 ? '0' + m : m) + '-' + (d < 10 ? '0' + d : d);
    };
    const getTodayStr = window.getTodayStr;

    // --- 2. Data Management ---
    // Local state for rendering (synced with Firebase)
    window.members = [];
    window.logs = [];
    window.instructors = {}; // [NEW]
    let currentScanSession = null;
    let currentMode = ''; // í˜„ì¬ í™œì„±í™”ëœ í˜ì´ì§€ ì¶”ì  (home, members, reports)
    let trendChartInstance = null; // Chart instance
    let undoTimer = null; // [NEW] Timer for the undo toast

    // [NEW] Function to show the undo toast
    function showUndoToast(message, onUndoCallback, duration = 5000) {
        const container = document.getElementById('toast-container');
        if (!container) return;

        const toastDiv = document.createElement('div');
        const isUndoable = !!onUndoCallback;
        const alertType = message.includes('âš ï¸') ? 'alert-warning' : (message.includes('ğŸš«') ? 'alert-error' : 'alert-success');
        
        toastDiv.className = `alert ${alertType} shadow-lg`;
        
        let innerHTML = `<span>${message}</span>`;
        if (isUndoable) {
            innerHTML += `<button class="btn btn-sm btn-ghost">ì¶œì„ ì·¨ì†Œ</button>`;
        }
        toastDiv.innerHTML = innerHTML;

        if (isUndoable) {
            toastDiv.querySelector('button').onclick = () => {
                onUndoCallback();
                toastDiv.remove();
            };
        }
        container.appendChild(toastDiv);
        setTimeout(() => {
            toastDiv.remove();
        }, 5000); // 5 seconds
    }

    // Real-time Listeners
    // 1. Members
    onSnapshot(query(collection(db, "members"), orderBy("name")), (snapshot) => {
        window.members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderMembers();
        updateCheckUserSelect(); // [FIX] íšŒì› ë°ì´í„° ë³€ê²½ ì‹œ, ì¶œì„ ëª¨ë‹¬ì˜ ë“œë¡­ë‹¤ìš´ë„ í•­ìƒ ì—…ë°ì´íŠ¸
        renderMemberGrid(); // íšŒì› ì¶œì„ ëª¨ë“œ ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
    });

    // 2. Logs
    onSnapshot(query(collection(db, "logs"), orderBy("timestamp", "desc")), (snapshot) => {
        window.logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        // ë¦¬í¬íŠ¸ í˜ì´ì§€ê°€ í™œì„±í™” ìƒíƒœì¼ ë•Œë§Œ ë°ì´í„° ìë™ ê°±ì‹ 
        if (currentMode === 'reports') {
            showReports();
        }
    });

    // 3. Instructors
    onSnapshot(collection(db, "instructors"), (snapshot) => {
        const instructorData = {};
        snapshot.forEach(doc => {
            instructorData[doc.id] = doc.data().name;
        });
        window.instructors = instructorData;
        
        // Update relevant UIs
        if (currentMode === 'home') { renderInstructorManagement(); }
        if (sessionStorage.getItem('appMode') === 'member') { syncMemberModeToNow(true); }
    });

    // [NEW] Helper function to populate the attendance check dropdown
    function updateCheckUserSelect() {
        const select = document.getElementById('check-user-select');
        const currentValue = select.value; // Preserve selection if possible

        select.innerHTML = '<option value="">â¬‡ï¸ ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ ì´ë¦„ ì„ íƒ</option>'; 
        
        window.members.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.id;
            opt.innerText = `${m.name} (${m.phone})`;
            select.appendChild(opt);
        });
        
        if (currentValue && window.members.some(m => m.id === currentValue)) {
            select.value = currentValue;
        }
    }

    // [NEW] Choseong Search Logic
    const getChoseong = (str) => {
        const choseong = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
        let result = "";
        for(let i=0; i<str.length; i++) {
            const code = str.charCodeAt(i) - 44032;
            if(code > -1 && code < 11172) result += choseong[Math.floor(code/588)];
            else result += str.charAt(i);
        }
        return result;
    };

    window.renderMemberGrid = function(query = "") {
        const grid = document.getElementById('member-grid');
        if (!grid) return;
        
        const trimmedQuery = query.trim();
        const filtered = trimmedQuery
            ? members.filter(m => m.name.includes(trimmedQuery) || getChoseong(m.name).includes(trimmedQuery))
            : members;
        
        grid.innerHTML = filtered.map(m => `
            <button onclick="handleMemberGridClick('${m.id}')"
                    class="btn h-auto flex-col items-center justify-center min-h-[120px] p-4 bg-base-100 border-2 border-base-300 shadow-sm">
                <span class="text-2xl font-bold">${m.name}</span>
                <span class="text-xs text-gray-400 mt-1">${m.phone === '0000' ? '' : m.phone}</span>
            </button>
        `).join('');
        
        if (filtered.length === 0) {
            if (trimmedQuery) {
                // No search results
                grid.innerHTML = `
                    <div class="col-span-full py-10 text-center">
                        <p class="text-gray-400 mb-4">'${trimmedQuery}' ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                        <button onclick="handleNewMemberGridClick('${trimmedQuery}')" class="btn btn-success text-white">
                            <i class="fas fa-user-plus mr-2"></i>
                            '${trimmedQuery}' ì‹ ê·œ ë“±ë¡ ë° ì¶œì„
                        </button>
                    </div>
                `;
            } else {
                // No members at all
                grid.innerHTML = `<div class="col-span-full py-10 text-gray-400">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            }
        }
    }

    window.handleMemberGridClick = function(memberId) {
        const dateStr = document.getElementById('member-mode-date').value;
        const sessionCode = document.getElementById('member-mode-session').value;
        const member = members.find(m => m.id === memberId);
        const session = SESSIONS.find(s => s.code === sessionCode);

        if (!session || sessionCode === "ìˆ˜ì—… ì—†ìŒ") {
            return alert("ì„ íƒëœ ë‚ ì§œì— ì§„í–‰ë˜ëŠ” ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤. ë‚ ì§œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }

        if (confirm(`[${session.name}]\n${member.name}ë‹˜, ì¶œì„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            confirmAttendanceWithId(memberId, false, dateStr, sessionCode);
        }
    }

    window.handleNewMemberGridClick = async function(name) {
        const dateStr = document.getElementById('member-mode-date').value;
        const sessionCode = document.getElementById('member-mode-session').value;
        const session = SESSIONS.find(s => s.code === sessionCode);

        if (!session || sessionCode === "ìˆ˜ì—… ì—†ìŒ") {
            return alert("ì„ íƒëœ ë‚ ì§œì— ì§„í–‰ë˜ëŠ” ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤. ë‚ ì§œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }

        if (confirm(`'${name}' ë‹˜ì€ ëª…ë‹¨ì— ì—†ìŠµë‹ˆë‹¤.\nìƒˆ íšŒì›ìœ¼ë¡œ ë“±ë¡í•˜ê³  ì¶œì„ ì²˜ë¦¬í• ê¹Œìš”?`)) {
            try {
                const existingMembers = members.filter(m => m.name === name);
                if (existingMembers.length > 0) {
                    if (!confirm(`ì´ë¯¸ ê°™ì€ ì´ë¦„ì˜ íšŒì›(${name})ì´ ${existingMembers.length}ëª… ì¡´ì¬í•©ë‹ˆë‹¤.\në™ëª…ì´ì¸ìœ¼ë¡œ ìƒˆë¡œ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        return; // User cancelled
                    }
                }

                // Create new member
                const docRef = await addDoc(collection(db, "members"), { name, phone: "0000", registeredAt: new Date() });
                
                // Immediately check in
                await confirmAttendanceWithId(docRef.id, true, dateStr, sessionCode);

            } catch (e) {
                console.error("ì‹ ê·œ íšŒì› ë“±ë¡ ë° ì¶œì„ ì²˜ë¦¬ ì‹¤íŒ¨:", e);
                alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }
    }

    // --- 3. Helper Functions ---
    window.getWeekOfMonth = function(dateStr) {
        const d = new Date(dateStr);
        const date = d.getDate();
        const firstDayOfMonth = new Date(d.getFullYear(), d.getMonth(), 1).getDay();
        return Math.ceil((date + firstDayOfMonth) / 7);
    }

    window.getCurrentSession = function() {
        const now = new Date();
        const day = now.getDay();
        const hour = now.getHours();
        return SESSIONS.find(s => s.day === day && hour >= s.start && hour < s.end);
    }

    window.updateMemberModeSessionOptions = function() {
        const dateStr = document.getElementById('member-mode-date').value;
        if(!dateStr) return;
        const [y, m, d] = dateStr.split('-').map(Number);
        const day = new Date(y, m - 1, d).getDay();

        const select = document.getElementById('member-mode-session');
        select.innerHTML = '';
        const availableSessions = SESSIONS.filter(s => s.day === day);
        availableSessions.forEach(s => {
            const opt = document.createElement('option'); opt.value = s.code; opt.innerText = s.name; select.appendChild(opt);
        });
        if(availableSessions.length === 0) {
            const opt = document.createElement('option'); opt.innerText = "ìˆ˜ì—… ì—†ìŒ"; select.appendChild(opt);
        }
    }

    // --- [NEW] Animation Helper ---
    const animateCountUp = (element, end, duration = 1500) => {
        if (!element) return;
        const startTimestamp = performance.now();
        const step = (timestamp) => {
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const current = Math.floor(progress * end);
            element.innerText = `${current}ëª…`;
            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                element.innerText = `${end}ëª…`; // Ensure final value is exact
            }
        };
        element.innerText = '0ëª…'; // Start from 0
        window.requestAnimationFrame(step);
    };

    // --- 4. Report Logic ---
    let newMembersChartInstance = null;

    // ë¦¬í¬íŠ¸ íƒ­ UI ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì •
    const initializeReportTabs = () => {
        const wrapper = document.getElementById('report-tabs-wrapper');
        if (!wrapper) return;
        wrapper.innerHTML = ''; // Clear

        const tabData = [
            { id: 'dashboard', name: 'ëŒ€ì‹œë³´ë“œ' },
            { id: 'class-weekly', name: 'ì°¨ìˆ˜ë³„ ì£¼ê°„' },
            { id: 'member-weekly', name: 'ê°œì¸ë³„ ì£¼ê°„' },
            { id: 'member-rank', name: 'ì¶œì„ ìˆœìœ„' },
            { id: 'class-popularity', name: 'ìˆ˜ì—… ì°¸ì—¬' },
            { id: 'new-member-trend', name: 'ì‹ ê·œ íšŒì›' },
            { id: 'inactive-members', name: 'ì¥ê¸° ë¯¸ì¶œì„' }
        ];

        const tabContainer = document.createElement('div');
        tabContainer.className = 'tabs tabs-lifted';
        tabContainer.setAttribute('role', 'tablist');

        // Move existing panels into the tab structure
        const reportContents = document.getElementById('report-contents');

        tabData.forEach((tab, index) => {
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'report_tabs';
            radio.className = 'tab';
            radio.setAttribute('role', 'tab');
            radio.setAttribute('aria-label', tab.name);
            if (index === 0) radio.checked = true;

            const panel = document.getElementById(`report-content-${tab.id}`);
            if (panel) {
                panel.className = 'tab-content bg-base-100 border-base-300 rounded-box p-4 sm:p-6';
                tabContainer.appendChild(radio);
                tabContainer.appendChild(panel);
            }
        });
        
        wrapper.appendChild(tabContainer);
        reportContents.remove(); // Remove the old container
    };

    // --- ê¸°ì¡´ ë¦¬í¬íŠ¸ ë¡œì§ì„ ìƒˆ êµ¬ì¡°ì— ë§ê²Œ ì¬êµ¬ì„± ---
    const renderReport_MonthlyTotal = (logsForMonth) => {
        const uniqueMembers = new Set(logsForMonth.map(log => log.memberId)).size;
        animateCountUp(document.getElementById('report-monthly-total'), uniqueMembers);
    };

    const renderReport_MemberRank = (logsForMonth, members) => {
        const container = document.getElementById('report-member-ranking');
        container.innerHTML = '';
        
        const table = document.createElement('table');
        table.className = 'table table-zebra w-full';
        table.innerHTML = `<thead class="text-xs text-gray-700 uppercase bg-gray-50">
                <tr>
                    <th scope="col" class="px-4 py-3">ìˆœìœ„</th>
                    <th scope="col" class="px-4 py-3">ì´ë¦„</th>
                    <th scope="col" class="px-4 py-3">ì „í™”ë²ˆí˜¸</th>
                    <th scope="col" class="px-4 py-3 text-right">íšŸìˆ˜</th>
                </tr>
            </thead>`;
        const tbody = document.createElement('tbody');

        const memberCounts = {};
        logsForMonth.forEach(log => {
            if (!memberCounts[log.memberId]) {
                const m = members.find(mem => mem.id === log.memberId);
                memberCounts[log.memberId] = { count: 0, name: log.memberName, phone: m ? m.phone : "" };
            }
            memberCounts[log.memberId].count++;
        });
        const sortedMembers = Object.values(memberCounts).sort((a, b) => b.count - a.count);

        if (sortedMembers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        } else {
            sortedMembers.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover animate-fadeInUp';
                tr.style.animationDelay = `${index * 50}ms`; // ìˆœì°¨ì  ì• ë‹ˆë©”ì´ì…˜ ë”œë ˆì´
                tr.innerHTML = `
                    <td class="px-4 py-4 font-medium text-gray-900">${index + 1}</td>
                    <td class="px-4 py-4 font-bold">${item.name}</td>
                    <td class="px-4 py-4 text-xs text-gray-400">${item.phone || '-'}</td>
                    <td class="px-4 py-4 text-right font-bold text-indigo-600">${item.count}íšŒ</td>`;
                tbody.appendChild(tr);
            });
        }
        table.appendChild(tbody);
        container.appendChild(table);
    };

    const renderReport_ClassWeekly = (logsForMonth) => {
        const container = document.getElementById('report-class-weekly-attendance');
        container.innerHTML = '';

        const sessionWeeklyCounts = {};
        logsForMonth.forEach(log => {
            const week = getWeekOfMonth(log.date);
            const sessionName = log.sessionName;
            if (!sessionWeeklyCounts[sessionName]) {
                sessionWeeklyCounts[sessionName] = { name: sessionName, weeks: {1:0, 2:0, 3:0, 4:0, 5:0}, total: 0 };
            }
            if (sessionWeeklyCounts[sessionName].weeks[week] !== undefined) {
                sessionWeeklyCounts[sessionName].weeks[week]++;
            }
            sessionWeeklyCounts[sessionName].total++;
        });

        const sortedSessionWeekly = Object.values(sessionWeeklyCounts).sort((a, b) => {
            const indexA = SESSIONS.findIndex(s => s.name === a.name);
            const indexB = SESSIONS.findIndex(s => s.name === b.name);
            return indexA - indexB;
        });

        const table = document.createElement('table');
        table.className = 'table table-zebra w-full';
        table.innerHTML = `
            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                <tr>
                    <th scope="col" class="px-2 py-3">ì°¨ìˆ˜(ë°˜)</th>
                    <th scope="col" class="px-2 py-3 text-center">1ì£¼</th>
                    <th scope="col" class="px-2 py-3 text-center">2ì£¼</th>
                    <th scope="col" class="px-2 py-3 text-center">3ì£¼</th>
                    <th scope="col" class="px-2 py-3 text-center">4ì£¼</th>
                    <th scope="col" class="px-2 py-3 text-center">5ì£¼</th>
                    <th scope="col" class="px-2 py-3 text-right">ê³„</th>
                </tr>
            </thead>`;
        const tbody = document.createElement('tbody');

        if (sortedSessionWeekly.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        } else {
            sortedSessionWeekly.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover animate-fadeInUp';
                tr.style.animationDelay = `${index * 50}ms`;

                const weekCells = [1, 2, 3, 4, 5].map(weekNum => {
                    const count = item.weeks[weekNum];
                    return count > 0 
                        ? `<td class="px-2 py-4 text-center text-gray-500 cursor-pointer underline" onclick="openSessionAttendeesModal('${item.name}', ${weekNum})">${count}</td>` 
                        : `<td class="px-2 py-4 text-center text-gray-500">-</td>`;
                }).join('');

                const totalCell = item.total > 0 
                    ? `<td class="px-2 py-4 text-right font-bold text-blue-600 cursor-pointer underline" onclick="openSessionAttendeesModal('${item.name}', null)">${item.total}</td>` 
                    : `<td class="px-2 py-4 text-right font-bold text-blue-600">${item.total}</td>`;

                const nameParts = item.name.split(' ');
                const dayPart = nameParts[0].charAt(0);
                const timePart = nameParts.slice(1).join('');
                const shortName = dayPart + timePart;

                tr.innerHTML = `<td class="px-2 py-4 font-bold text-green-700 whitespace-nowrap">${shortName}</td>${weekCells}${totalCell}`;
                tbody.appendChild(tr);
            });
        }
        table.appendChild(tbody);
        container.appendChild(table);
    };

    const renderReport_MemberWeekly = (logsForMonth) => {
        const container = document.getElementById('report-member-weekly-attendance');
        container.innerHTML = '';

        const individualWeekly = {};
        logsForMonth.forEach(log => {
            const week = getWeekOfMonth(log.date);
            if (!individualWeekly[log.memberId]) {
                individualWeekly[log.memberId] = { id: log.memberId, name: log.memberName, weeks: {1:0, 2:0, 3:0, 4:0, 5:0}, total: 0 };
            }
            if (individualWeekly[log.memberId].weeks[week] !== undefined) individualWeekly[log.memberId].weeks[week]++;
            individualWeekly[log.memberId].total++;
        });

        const sortedIndiv = Object.values(individualWeekly).sort((a, b) => a.name.localeCompare(b.name));
        
        const table = document.createElement('table');
        table.className = 'table table-zebra w-full';
        table.innerHTML = `
            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                <tr>
                    <th scope="col" class="px-2 py-3">ì´ë¦„</th>
                    <th scope="col" class="px-2 py-3 text-center">1ì£¼</th>
                    <th scope="col" class="px-2 py-3 text-center">2ì£¼</th>
                    <th scope="col" class="px-2 py-3 text-center">3ì£¼</th>
                    <th scope="col" class="px-2 py-3 text-center">4ì£¼</th>
                    <th scope="col" class="px-2 py-3 text-center">5ì£¼</th>
                    <th scope="col" class="px-2 py-3 text-right">ê³„</th>
                </tr>
            </thead>`;
        const tbody = document.createElement('tbody');

        if (sortedIndiv.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        } else {
            sortedIndiv.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover animate-fadeInUp';
                tr.style.animationDelay = `${index * 50}ms`;
                tr.innerHTML = `
                    <td class="px-2 py-4 font-bold text-indigo-600 cursor-pointer hover:underline whitespace-nowrap" onclick="openHistoryModal('${item.id}')">${item.name}</td>
                    <td class="px-2 py-4 text-center text-gray-500">${item.weeks[1] || '-'}</td>
                    <td class="px-2 py-4 text-center text-gray-500">${item.weeks[2] || '-'}</td>
                    <td class="px-2 py-4 text-center text-gray-500">${item.weeks[3] || '-'}</td>
                    <td class="px-2 py-4 text-center text-gray-500">${item.weeks[4] || '-'}</td>
                    <td class="px-2 py-4 text-center text-gray-500">${item.weeks[5] || '-'}</td>
                    <td class="px-2 py-4 text-right font-bold text-blue-600">${item.total}</td>`;
                tbody.appendChild(tr);
            });
        }
        table.appendChild(tbody);
        container.appendChild(table);
    };

    // --- ì‹ ê·œ ë¦¬í¬íŠ¸ 3ì¢… ë° í—¬í¼ í•¨ìˆ˜ ---
    const renderReport_ClassPopularity = (logs) => {
        const container = document.getElementById('report-class-popularity');
        container.innerHTML = '';

        if (!logs || !logs.length) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">í•´ë‹¹ ì›”ì˜ ì¶œì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        const classCounts = logs.reduce((acc, log) => {
            const sessionName = log.sessionName || 'ì•Œ ìˆ˜ ì—†ëŠ” ìˆ˜ì—…';
            acc[sessionName] = (acc[sessionName] || 0) + 1;
            return acc;
        }, {});
        const sortedClasses = Object.entries(classCounts).sort(([, countA], [, countB]) => countB - countA);
        
        const table = document.createElement('table');
        table.className = 'table table-zebra w-full';
        table.innerHTML = `<thead class="text-xs text-gray-700 uppercase bg-gray-50">
                <tr><th scope="col" class="px-4 py-3">ìˆœìœ„</th><th scope="col" class="px-4 py-3">ìˆ˜ì—…</th><th scope="col" class="px-4 py-3 text-right">ì´ ì¶œì„ì¸ì›</th></tr>
            </thead>`;
        const tbody = document.createElement('tbody');

        sortedClasses.forEach(([sessionName, count], index) => {
            const tr = document.createElement('tr');
            tr.className = 'hover animate-fadeInUp';
            tr.style.animationDelay = `${index * 50}ms`;
            tr.innerHTML = `<td class="px-4 py-4 font-medium text-gray-900">${index + 1}</td><td class="px-4 py-4">${sessionName}</td><td class="px-4 py-4 text-right font-semibold">${count}ëª…</td>`;
            tbody.appendChild(tr);
        });
        
        table.appendChild(tbody);
        container.appendChild(table);
    };

    const renderReport_NewMemberTrend = (members) => {
        const ctx = document.getElementById('new-members-chart').getContext('2d');
        const labels = []; const data = []; const monthData = [];
        for (let i = 5; i >= 0; i--) {
            const d = new Date(); d.setDate(1); d.setMonth(d.getMonth() - i);
            const year = d.getFullYear(); const month = d.getMonth();
            labels.push(`${month + 1}ì›”`);
            monthData.push({ year, month });
            const count = members.filter(member => {
                if (!member.registeredAt || !member.registeredAt.toDate) return false;
                const regDate = member.registeredAt.toDate();
                return regDate.getFullYear() === year && regDate.getMonth() === month;
            }).length;
            data.push(count);
        }
        if (newMembersChartInstance) newMembersChartInstance.destroy();
        newMembersChartInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'ì‹ ê·œ íšŒì› ìˆ˜', data, backgroundColor: 'rgba(34, 197, 94, 0.6)', borderColor: 'rgba(34, 197, 94, 1)', borderWidth: 1, borderRadius: 4 }] },
            options: { 
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } },
                onHover: (event, chartElement) => {
                    event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const { year, month } = monthData[elements[0].index];
                        showNewMembersModal(year, month);
                    }
                }
            }
        });
    };

    const renderReport_InactiveMembers = (allMembers, allLogs) => {
        const container = document.getElementById('report-inactive-members-list');
        const periodSelector = document.getElementById('inactive-period-selector');
        const days = parseInt(periodSelector.value);
        container.innerHTML = '<p class="text-gray-500 text-center py-4">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - days);
        const recentLogs = allLogs.filter(log => log.date && new Date(log.date) >= cutoffDate);
        const activeMemberIds = new Set(recentLogs.map(log => log.memberId));
        const inactiveMembers = allMembers.filter(member => !activeMemberIds.has(member.id));
        if (inactiveMembers.length === 0) {
            container.innerHTML = `<p class="text-gray-500 text-center py-4">ìµœê·¼ ${days}ì¼ ë™ì•ˆ ë¯¸ì¶œì„í•œ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
            return;
        }
        let html = `<table class="table table-zebra w-full">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th scope="col" class="px-4 py-3">ì´ë¦„</th><th scope="col" class="px-4 py-3">ì „í™”ë²ˆí˜¸</th><th scope="col" class="px-4 py-3">ê°€ì…ì¼</th></tr></thead><tbody>`;
        inactiveMembers.sort((a, b) => a.name.localeCompare(b.name)).forEach(member => {
            const registeredDate = member.registeredAt && member.registeredAt.toDate ? member.registeredAt.toDate().toLocaleDateString() : 'ì•Œ ìˆ˜ ì—†ìŒ';
            html += `<tr class="hover"><td class="px-4 py-4 font-medium text-gray-900">${member.name}</td><td class="px-4 py-4">${member.phone || '-'}</td><td class="px-4 py-4">${registeredDate}</td></tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    };

    const renderReport_TrendChart = (allLogs) => {
        const ctx = document.getElementById('attendance-trend-chart').getContext('2d');
        const labels = []; const data = [];
        let current = new Date(); current.setDate(1);
        for(let i=0; i<6; i++) {
            const y = current.getFullYear(); const m = String(current.getMonth() + 1).padStart(2, '0');
            const key = `${y}-${m}`;
            labels.unshift(`${current.getMonth() + 1}ì›”`);
            const count = new Set(allLogs.filter(l => l.date.startsWith(key)).map(l => l.memberId)).size;
            data.unshift(count);
            current.setMonth(current.getMonth() - 1);
        }
        if (trendChartInstance) trendChartInstance.destroy();
        trendChartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label: 'ì›”ê°„ ì¶œì„ ì¸ì›', data, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', borderWidth: 2, tension: 0.3, fill: true, pointBackgroundColor: '#ffffff', pointBorderColor: '#4f46e5', pointRadius: 4 }] },
            options: { responsive: true, maintainAspectRatio: false, layout: { padding: { top: 25 } }, plugins: { legend: { display: false }, datalabels: { display: true, align: 'top', anchor: 'end', offset: 4, color: '#4f46e5', font: { weight: 'bold', size: 12 }, formatter: (value) => value > 0 ? value : '' }, tooltip: { callbacks: { label: (context) => context.parsed.y + 'ëª…' } } }, scales: { y: { beginAtZero: true, grace: '15%', ticks: { stepSize: 1 }, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } } }
        });
    };

    // --- ë¦¬í¬íŠ¸ ë Œë”ë§ í†µí•© í•¨ìˆ˜ ---
    const renderMonthDependentReports = (allLogs, allMembers, month) => {
        const year = parseInt(month.split('-')[0]);
        const monthIndex = parseInt(month.split('-')[1]) - 1;
        const startDate = new Date(year, monthIndex, 1);
        const endDate = new Date(year, monthIndex + 1, 0);
        const logsForMonth = allLogs.filter(log => {
            const logDate = new Date(log.date);
            return logDate >= startDate && logDate <= endDate;
        });
        renderReport_MonthlyTotal(logsForMonth);
        renderReport_ClassWeekly(logsForMonth);
        renderReport_MemberWeekly(logsForMonth);
        renderReport_MemberRank(logsForMonth, allMembers);
        renderReport_ClassPopularity(logsForMonth);
    };

    window.showReports = function() {
        const allLogs = window.logs;
        const allMembers = window.members;
        initializeReportTabs();
        const monthFilter = document.getElementById('report-month-filter');
        if (!monthFilter.value) {
            monthFilter.value = new Date().toISOString().slice(0, 7);
        }
        monthFilter.onchange = () => {
            renderMonthDependentReports(allLogs, allMembers, monthFilter.value);
        };
        document.getElementById('inactive-period-selector').onchange = () => renderReport_InactiveMembers(allMembers, allLogs);
        renderReport_TrendChart(allLogs);
        renderReport_NewMemberTrend(allMembers);
        renderReport_InactiveMembers(allMembers, allLogs);
        renderMonthDependentReports(allLogs, allMembers, monthFilter.value);
    };

    // --- [NEW] Instructor Management Logic ---
    window.renderInstructorManagement = function() {
        const list = document.getElementById('instructor-management-list');
        if (!list) return;

        list.innerHTML = SESSIONS.map(session => {
            const instructorName = window.instructors[session.code] || 'ë¯¸ì§€ì •';
            const nameClass = instructorName === 'ë¯¸ì§€ì •' ? 'text-gray-400 italic' : 'text-indigo-600 font-bold';

            return `
                <li class="py-3 flex justify-between items-center">
                    <div>
                        <p class="font-bold text-gray-800">${session.name}</p>
                        <p class="text-sm ${nameClass}">${instructorName}</p>
                    </div>
                    <div class="card-actions">
                        <button onclick="editInstructor('${session.code}', '${window.instructors[session.code] || ''}')" class="btn btn-sm btn-outline btn-info">ìˆ˜ì •</button>
                        ${instructorName !== 'ë¯¸ì§€ì •' ? `<button onclick="deleteInstructor('${session.code}')" class="btn btn-sm btn-outline btn-error">ì‚­ì œ</button>` : ''}
                    </div>
                </li>
            `;
        }).join('');
    }

    window.editInstructor = async function(sessionCode, currentName) {
        const newName = prompt('ë‹´ë‹¹ ì‚¬ë²”ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', currentName);
        if (newName === null) return; // User cancelled
        if (newName.trim() === "") {
            alert('ì´ë¦„ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }
        try {
            await setDoc(doc(db, "instructors", sessionCode), { name: newName.trim() });
            alert('ë‹´ë‹¹ ì‚¬ë²” ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (error) { console.error("Error updating instructor: ", error); alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
    }

    window.deleteInstructor = async function(sessionCode) {
        if (confirm('í•´ë‹¹ ìˆ˜ì—…ì˜ ë‹´ë‹¹ ì‚¬ë²” ì§€ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            try {
                await deleteDoc(doc(db, "instructors", sessionCode));
                alert('ë‹´ë‹¹ ì‚¬ë²” ì •ë³´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) { console.error("Error deleting instructor: ", error); alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
        }
    }

    // --- 5. QR & Paper Input Logic ---
    window.openQRPrintModal = function() {
        const container = document.getElementById('static-qr-list');
        container.innerHTML = '';
        const baseUrl = window.location.href.split('?')[0];
        SESSIONS.forEach(s => {
            const wrapper = document.createElement('div');
            wrapper.className = "border-2 border-dashed border-gray-300 p-6 rounded-xl flex flex-col items-center page-break-inside-avoid";
            const title = document.createElement('h3'); title.className = "text-xl font-bold mb-1"; title.innerText = s.name;
            const sub = document.createElement('p'); sub.className = "text-gray-500 mb-4"; sub.innerText = `${s.start}:00 ~ ${s.end}:00`;
            const qrDiv = document.createElement('div');
            const targetUrl = `${baseUrl}?session=${s.code}`;
            new QRCode(qrDiv, { text: targetUrl, width: 180, height: 180, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.M });
            wrapper.appendChild(title); wrapper.appendChild(sub); wrapper.appendChild(qrDiv); container.appendChild(wrapper); 
        });
        document.getElementById('qr-print-modal').showModal();
    }

    window.openPaperInputModal = function() {
        const modal = document.getElementById('paper-input-modal');
        const todayStr = getTodayStr();
        
        // 1. ë‚ ì§œ ë¨¼ì € ì„¤ì •
        document.getElementById('paper-date').value = todayStr;
        // 2. í•´ë‹¹ ë‚ ì§œì˜ ìˆ˜ì—… ì˜µì…˜ë“¤ ìƒì„±
        updateSessionOptions();
        // 3. í˜„ì¬ ì‹œê°„ì— ë§ëŠ” ìˆ˜ì—…(ì°¨ìˆ˜) ìë™ ì„ íƒ
        const current = getCurrentSession();
        const select = document.getElementById('paper-session-select');
        if (current && select) {
            select.value = current.code;
        }

        document.getElementById('paper-text-area').value = '';
        modal.showModal();
    }

    window.syncPaperInputToNow = function() {
        const todayStr = getTodayStr();
        document.getElementById('paper-date').value = todayStr;
        updateSessionOptions();
        
        const current = getCurrentSession();
        const select = document.getElementById('paper-session-select');
        if (current && select) {
            select.value = current.code;
        }

        document.getElementById('paper-text-area').value = '';
        modal.showModal();
    }

    window.syncPaperInputToNow = function() {
        const todayStr = getTodayStr();
        document.getElementById('paper-date').value = todayStr;
        updateSessionOptions();
        
        const current = getCurrentSession();
        const select = document.getElementById('paper-session-select');
        if (current && select) {
            select.value = current.code;
        }
        alert("í˜„ì¬ ì‹œê°„ì˜ ìˆ˜ì—…ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    window.updateSessionOptions = function() {
        const dateStr = document.getElementById('paper-date').value;
        if(!dateStr) return;
        // ë¡œì»¬ ì‹œê°„ ê¸°ì¤€ ìš”ì¼ ê³„ì‚°
        const [y, m, d] = dateStr.split('-').map(Number);
        const day = new Date(y, m - 1, d).getDay();

        const select = document.getElementById('paper-session-select');
        select.innerHTML = '';
        const availableSessions = SESSIONS.filter(s => s.day === day);
        if(availableSessions.length > 0) {
            availableSessions.forEach(s => {
                const opt = document.createElement('option'); opt.value = s.code; opt.innerText = s.name; select.appendChild(opt);
            });
        } else {
            const opt = document.createElement('option'); opt.innerText = "í•´ë‹¹ ìš”ì¼ì—” ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤."; select.appendChild(opt);
        }
    }

    window.processPaperInput = async function() {
        const dateStr = document.getElementById('paper-date').value;
        const sessionCode = document.getElementById('paper-session-select').value;
        const text = document.getElementById('paper-text-area').value;
        
        if(!dateStr) return alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        if(!sessionCode || sessionCode.startsWith("í•´ë‹¹")) return alert('ìœ íš¨í•œ ìˆ˜ì—…(ì°¨ìˆ˜)ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        if(!text.trim()) return alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        const session = SESSIONS.find(s => s.code === sessionCode);
        const lines = text.split(/[\n,]+/).map(n => n.trim()).filter(n => n.length > 0);
        
        let successCount = 0; let newMemberCount = 0; let duplicateCount = 0;
        let successNames = [];
        
        const batch = writeBatch(db);
        let tempMembers = [...members]; // Local cache for this batch operation
        const processedInBatch = new Set(); // To prevent duplicates within the same bulk input
        
        lines.forEach(line => {
            let inputName = line; let inputPhone = null;
            const match = line.match(/^(.*?)[\s]+(\d{4})$/);
            if (match) { inputName = match[1].trim(); inputPhone = match[2]; }
            
            let candidates = tempMembers.filter(m => m.name === inputName);
            let targetMember = null;

            if (candidates.length === 0) {
                // Create new member ref
                const newMemberRef = doc(collection(db, "members"));
                const newMemberData = { name: inputName, phone: inputPhone || "0000", registeredAt: new Date() };
                batch.set(newMemberRef, newMemberData);
                
                targetMember = { id: newMemberRef.id, ...newMemberData };
                tempMembers.push(targetMember);
                newMemberCount++;
            } else if (candidates.length === 1) {
                if (inputPhone && candidates[0].phone !== "0000" && candidates[0].phone !== inputPhone) {
                    // Different person (same name, diff phone)
                    const newMemberRef = doc(collection(db, "members"));
                    const newMemberData = { name: inputName, phone: inputPhone, registeredAt: new Date() };
                    batch.set(newMemberRef, newMemberData);
                    
                    targetMember = { id: newMemberRef.id, ...newMemberData };
                    tempMembers.push(targetMember);
                    newMemberCount++;
                } else {
                    targetMember = candidates[0];
                    if(targetMember.phone === "0000" && inputPhone) {
                        // Update phone number
                        batch.update(doc(db, "members", targetMember.id), { phone: inputPhone });
                        targetMember.phone = inputPhone;
                    }
                }
            } else {
                if (inputPhone) targetMember = candidates.find(m => m.phone === inputPhone);
                if (!targetMember && inputPhone) {
                    const newMemberRef = doc(collection(db, "members"));
                    const newMemberData = { name: inputName, phone: inputPhone, registeredAt: new Date() };
                    batch.set(newMemberRef, newMemberData);
                    targetMember = { id: newMemberRef.id, ...newMemberData };
                    tempMembers.push(targetMember);
                    newMemberCount++;
                }
            }
            
            if (targetMember) {
                // Check logs in memory (since we have real-time sync)
                const alreadyExists = logs.some(l => l.memberId === targetMember.id && l.date === dateStr && l.sessionCode === sessionCode);
                const alreadyInBatch = processedInBatch.has(targetMember.id);
                if(alreadyExists || alreadyInBatch) {
                    duplicateCount++;
                } else {
                    const newLogRef = doc(collection(db, "logs"));
                    batch.set(newLogRef, {
                        memberId: targetMember.id, 
                        memberName: targetMember.name, 
                        date: dateStr, 
                        sessionCode: session.code, 
                        sessionName: session.name, 
                        timestamp: new Date().toLocaleString() + " (ëª…ë¶€ì…ë ¥)"
                    });
                    processedInBatch.add(targetMember.id);
                    successNames.push(targetMember.name);
                    successCount++;
                }
            }
        });
        
        await batch.commit();
        if (successCount > 0) {
            playSound();
            const namesStr = successNames.join(', ');
            alert(`âœ… ë“±ë¡ ì™„ë£Œ\nì¼ì: ${dateStr}\nì°¨ìˆ˜: ${session.name}\nì„±í•¨: ${namesStr}\n\n(ì´ ${successCount}ëª… ì²˜ë¦¬ / ì¤‘ë³µ ì œì™¸: ${duplicateCount}ëª… / ì‹ ê·œ ê°€ì…: ${newMemberCount}ëª…)`);
        } else {
            alert(`ì²˜ë¦¬í•  ìƒˆë¡œìš´ ëª…ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.\n(ì¤‘ë³µ ì œì™¸: ${duplicateCount}ëª…)`);
        }
        
        // ì…ë ¥ì°½ ì´ˆê¸°í™” (í™”ë©´ì€ ë‹«ì§€ ì•ŠìŒ)
        document.getElementById('paper-text-area').value = '';
    }

    // --- 6. Attendance Logic (Scan) ---
    window.checkUrlForScan = function(silent = false) {
        const params = new URLSearchParams(window.location.search);
        const sessionCode = params.get('session');
        
        // Clear session from URL immediately to prevent loops
        if (sessionCode) {
            history.replaceState({}, document.title, window.location.pathname);
        }

        if (sessionCode) {
            const session = SESSIONS.find(s => s.code === sessionCode);
            if (session) {
                const now = new Date();
                const isWrongDay = now.getDay() !== session.day;
                const isWrongTime = now.getHours() < session.start || now.getHours() >= session.end;
                
                if (!silent && (isWrongDay || isWrongTime)) {
                    const msg = isWrongDay ? `ì˜¤ëŠ˜ì€ ${DAYS[now.getDay()]}ìš”ì¼ì…ë‹ˆë‹¤.` : `í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ìˆ˜ì—… ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.`;
                    if(!confirm(`âš ï¸ QR ì •ë³´ì™€ í˜„ì¬ ì‹œê°„ì´ ë‹¤ë¦…ë‹ˆë‹¤.\n(${session.name})\n\nê·¸ë˜ë„ ì¶œì„ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        if (sessionStorage.getItem('isAdminLoggedIn') !== 'true') showLoginScreen();
                        return;
                    }
                }
                handleScan(session);
            } else {
                if (!silent) alert("ìœ íš¨í•˜ì§€ ì•Šì€ QR ì½”ë“œì…ë‹ˆë‹¤.");
                if (sessionStorage.getItem('isAdminLoggedIn') !== 'true') showLoginScreen();
            }
        }
    }
    window.handleScan = function(session, silent = false) {
        const now = new Date();
        const isWrongDay = now.getDay() !== session.day;
        const isWrongTime = now.getHours() < session.start || now.getHours() >= session.end;

        // Clear session from URL immediately to prevent loops
        history.replaceState({}, document.title, window.location.pathname);

        if (isWrongDay || isWrongTime) {
            if (!silent) {
                const msg = isWrongDay ? `ì˜¤ëŠ˜ì€ ${DAYS[now.getDay()]}ìš”ì¼ì…ë‹ˆë‹¤.` : `í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.`;
                alert(`âŒ ì¶œì„ ì‹¤íŒ¨\n${msg}`);
            }
            return;
        }
        currentScanSession = session;
        const modal = document.getElementById('user-check-modal');
        document.getElementById('scan-info').innerText = `[${session.name}]`;
        
        // Reset UI
        toggleCheckMode('manual'); // Set manual input as default
        document.getElementById('check-manual-name').value = '';
        document.getElementById('check-manual-phone').value = '';

        // [FIX] Don't populate list here. Just reset the selection.
        document.getElementById('check-user-select').value = '';
        modal.showModal();
    }

    window.toggleCheckMode = function(mode) {
        if (mode === 'manual') {
            document.getElementById('check-existing-wrapper').classList.add('hidden');
            document.getElementById('check-manual-wrapper').classList.remove('hidden');
        } else {
            document.getElementById('check-existing-wrapper').classList.remove('hidden');
            document.getElementById('check-manual-wrapper').classList.add('hidden');
        }
    }

    window.confirmAttendance = async function() {
        const isManual = !document.getElementById('check-manual-wrapper').classList.contains('hidden');
        let member = null;
        let isNewMember = false;

        if (isManual) {
            const name = document.getElementById('check-manual-name').value.trim();
            const phone = document.getElementById('check-manual-phone').value.trim() || "0000";
            if (!name) return alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            
            // [NEW] Find or Create Logic
            // 1. Try to find the member from the local list
            let candidates = window.members.filter(m => m.name === name);
            
            if (phone !== "0000") {
                // If phone is provided, find an exact match
                member = candidates.find(m => m.phone === phone);
            } else if (candidates.length === 1) {
                // If no phone is provided and there's only one person with that name
                member = candidates[0];
            } else if (candidates.length > 1) {
                return alert(`ë™ëª…ì´ì¸(${name})ì´ ìˆìŠµë‹ˆë‹¤. ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ë¥¼ ì…ë ¥í•˜ì—¬ êµ¬ë¶„í•´ì£¼ì„¸ìš”.`);
            }

            // 2. If not found, create a new one
            if (!member) {
                try {
                    const docRef = await addDoc(collection(db, "members"), { name, phone, registeredAt: new Date() });
                    member = { id: docRef.id, name, phone, registeredAt: new Date() };
                    isNewMember = true;
                } catch (e) {
                    console.error(e);
                    return alert("íšŒì› ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            }
        } else {
            const memberId = document.getElementById('check-user-select').value;
            if(!memberId) return alert('íšŒì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            member = members.find(m => m.id === memberId);
        }

        await confirmAttendanceWithId(member?.id, isNewMember);
    }

    window.confirmAttendanceWithId = async function(memberId, isNewMember = false, manualDate = null, manualSessionCode = null) {
        const member = members.find(m => m.id === memberId);
        if (!member) return alert('íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

        const dateStr = manualDate || document.getElementById('check-date').value;
        const sessionCode = manualSessionCode || document.getElementById('check-session-select').value;
        const session = SESSIONS.find(s => s.code === sessionCode);
        
        if(!session) return alert('ìœ íš¨í•œ ìˆ˜ì—…(ì°¨ìˆ˜)ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');

        const alreadyChecked = logs.some(log => log.memberId === member.id && log.date === dateStr && log.sessionCode === session.code);
        
        if(alreadyChecked) {
            showUndoToast('âš ï¸ ì´ë¯¸ ì¶œì„ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            const newLogData = {
                memberId: member.id, 
                memberName: member.name, 
                date: dateStr, 
                sessionCode: session.code, 
                sessionName: session.name, 
                timestamp: new Date().toLocaleString()
            };
            const docRef = await addDoc(collection(db, "logs"), newLogData);
            
            playSound();
            let message = `âœ… ${member.name}ë‹˜ ì¶œì„ ì™„ë£Œ!`;
            if (isNewMember) {
                message += ' (ì‹ ê·œ ë“±ë¡)';
            }
            
            showUndoToast(message, async () => { // Undo callback
                await deleteDoc(doc(db, "logs", docRef.id));
                showUndoToast(`ğŸš« ${member.name}ë‹˜ì˜ ì¶œì„ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            });
        }
        document.getElementById('member-search-input').value = '';
        document.getElementById('user-check-modal').close();
        renderMemberGrid();
    }
    window.closeCheckModal = function() {
        document.getElementById('user-check-modal').classList.add('hidden');
        history.replaceState({}, document.title, window.location.pathname);
        
        const isAdmin = sessionStorage.getItem('isAdminLoggedIn') === 'true';
        const isMemberMode = sessionStorage.getItem('appMode') === 'member';
        
        if (!isAdmin && !isMemberMode) showLoginScreen();
    }

    // --- 7. History Modal Logic ---
    window.openHistoryModal = function(memberId) {
        const member = members.find(m => m.id === memberId);
        if(!member) return;
        document.getElementById('history-member-name').innerText = `${member.name} ë‹˜ì˜ ì¶œì„ ì´ë ¥`;
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        const history = logs.filter(l => l.memberId === memberId).sort((a, b) => b.id - a.id);
        if(history.length === 0) {
            list.innerHTML = '<li class="text-center text-gray-400 py-4">ì¶œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
        } else {
            history.forEach(h => {
                list.innerHTML += `<li class="bg-gray-50 p-3 rounded border border-gray-100"><div class="flex justify-between items-center mb-1"><span class="font-bold text-gray-700">${h.date}</span><span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded">${h.sessionName}</span></div><div class="text-xs text-gray-400 text-right">${h.timestamp}</div></li>`;
            });
        }
        document.getElementById('history-modal').showModal();
    }

    // --- [NEW] Session Attendees Modal Logic ---
    window.openSessionAttendeesModal = function(sessionName, week) { // week is 1-5, or null for total
        const selectedMonth = document.getElementById('report-month-filter').value;
        
        let sessionLogs = logs.filter(log => 
            log.date.startsWith(selectedMonth) && log.sessionName === sessionName
        );

        let subtitle;
        if (week) {
            sessionLogs = sessionLogs.filter(log => getWeekOfMonth(log.date) === week);
            subtitle = `${selectedMonth}ì›” / ${week}ì£¼ì°¨`;
        } else {
            subtitle = `${selectedMonth}ì›” / ì „ì²´`;
        }

        const attendees = [...new Set(sessionLogs.map(log => log.memberName))].sort((a, b) => a.localeCompare(b));

        document.getElementById('session-attendees-title').innerText = `[${sessionName}] ì°¸ì„ì`;
        document.getElementById('session-attendees-subtitle').innerText = `${subtitle} / ì´ ${attendees.length}ëª… (ì¤‘ë³µì œì™¸)`;
        
        const list = document.getElementById('session-attendees-list');
        list.innerHTML = '';

        if (attendees.length === 0) {
            list.innerHTML = '<li class="text-center text-gray-400 py-4">ì°¸ì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
        } else {
            attendees.forEach(name => list.innerHTML += `<li class="bg-gray-50 p-2 rounded">${name}</li>`);
        }
        document.getElementById('session-attendees-modal').showModal();
    }

    // --- [NEW] New Members Modal Logic ---
    window.showNewMembersModal = function(year, month) {
        const modal = document.getElementById('new-members-modal');
        const subtitle = document.getElementById('new-members-subtitle');
        const list = document.getElementById('new-members-list');

        const newMembersInMonth = window.members.filter(member => {
            if (!member.registeredAt || !member.registeredAt.toDate) return false;
            const regDate = member.registeredAt.toDate();
            return regDate.getFullYear() === year && regDate.getMonth() === month;
        });

        subtitle.innerText = `${year}ë…„ ${month + 1}ì›” ê°€ì… / ì´ ${newMembersInMonth.length}ëª…`;
        list.innerHTML = '';

        if (newMembersInMonth.length === 0) {
            list.innerHTML = '<li class="text-center text-gray-400 py-4">í•´ë‹¹ ì›”ì˜ ì‹ ê·œ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
        } else {
            newMembersInMonth
                .sort((a, b) => a.name.localeCompare(b.name))
                .forEach(member => {
                    const regDateStr = member.registeredAt.toDate().toLocaleDateString();
                    list.innerHTML += `<li class="bg-gray-50 p-3 rounded flex justify-between items-center"><span class="font-bold text-gray-800">${member.name}</span><span class="text-xs text-gray-500">${regDateStr}</span></li>`;
                });
        }
        modal.showModal();
    }

    // --- 8. Common Functions ---
    window.addMember = async function() {
        const name = document.getElementById('new-member-name').value;
        let phone = document.getElementById('new-member-phone').value;
        if (!name) return alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        if (!phone) phone = "0000";

        // [NEW] Duplicate Check
        const isDuplicate = members.some(m => m.name === name && m.phone === phone);
        if (isDuplicate) {
            return alert(`âš ï¸ ì´ë¯¸ ë“±ë¡ëœ íšŒì›ì…ë‹ˆë‹¤.\n(ì´ë¦„: ${name}, ë²ˆí˜¸: ${phone})`);
        }
        
        await addDoc(collection(db, "members"), { name, phone, registeredAt: new Date() });
        document.getElementById('new-member-name').value = ''; document.getElementById('new-member-phone').value = '';
        alert('íšŒì›ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    window.renderMembers = function() {
        const list = document.getElementById('member-list');
        document.getElementById('member-count').innerText = `(${members.length}ëª…)`;
        list.innerHTML = '';
        members.forEach(m => { 
            list.innerHTML += `<li class="py-4 flex justify-between items-center"><div onclick="openHistoryModal('${m.id}')" class="cursor-pointer flex-1 hover:bg-gray-50 p-2 rounded transition"><p class="font-bold text-lg text-gray-800 flex items-center">${m.name} <i class="fas fa-chevron-right text-gray-300 text-xs ml-2"></i></p><p class="text-sm text-gray-400">${m.phone}</p></div><button onclick="deleteMember('${m.id}')" class="btn btn-sm btn-outline btn-error ml-2">ì‚­ì œ</button></li>`;
        });
    }
    
    window.deleteMember = async function(id) {
        const hasHistory = logs.some(log => log.memberId === id);
        if (hasHistory) {
            alert("âŒ ì‚­ì œ ì‹¤íŒ¨\nì´ íšŒì›ì˜ ì¶œì„ ê¸°ë¡ì´ ì¡´ì¬í•©ë‹ˆë‹¤.\nê¸°ë¡ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const isAuthorized = await requestPassword();
        if (!isAuthorized) return;

        if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            await deleteDoc(doc(db, "members", id));
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    window.resetData = async function() { 
        const isAuthorized = await requestPassword();
        if (!isAuthorized) return;

        const modal = document.getElementById('reset-confirm-modal');
        const input = document.getElementById('reset-confirm-input');
        input.value = '';
        modal.showModal();
        input.focus();
    }

    window.handleResetFinalConfirm = async function() { 
        const input = document.getElementById('reset-confirm-input').value.trim();
        if (input === "ì´ˆê¸°í™”") {
            const batch = writeBatch(db);
            members.forEach(m => batch.delete(doc(db, "members", m.id)));
            logs.forEach(l => batch.delete(doc(db, "logs", l.id)));
            await batch.commit();
            alert("ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload(); 
        } else {
            alert("ì…ë ¥ê°’ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. 'ì´ˆê¸°í™”'ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”."); 
        }
    }

    // --- [NEW] Password Confirmation Modal Logic ---
    let passwordResolve = null;
    window.requestPassword = function() {
        const lockout = JSON.parse(localStorage.getItem('adminLockout') || '{"attempts":0, "until":0}');
        const now = Date.now();
        if (now < lockout.until) {
            const remaining = Math.ceil((lockout.until - now) / 1000);
            alert(`ğŸ” ë³´ì•ˆ ì œí•œ: ë¹„ë°€ë²ˆí˜¸ë¥¼ ì—¬ëŸ¬ ë²ˆ í‹€ë ¤ ì‹œë„ê°€ ì œí•œë˜ì—ˆìŠµë‹ˆë‹¤.\n${remaining}ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
            return Promise.resolve(false);
        }

        return new Promise((resolve) => {
            passwordResolve = resolve;
            const modal = document.getElementById('password-confirm-modal');
            const input = document.getElementById('confirm-pw-input');
            input.value = ''; 
            modal.showModal();
            input.focus();
        });
    };

    window.handlePasswordConfirm = function() {
        const input = document.getElementById('confirm-pw-input');
        const pw = input.value.trim();
        const storedPw = (localStorage.getItem('adminPassword') || '1234').trim();
        let lockout = JSON.parse(localStorage.getItem('adminLockout') || '{"attempts":0, "until":0}');

        if (pw === storedPw) {
            localStorage.setItem('adminLockout', JSON.stringify({attempts: 0, until: 0}));
            document.getElementById('password-confirm-modal').close();
            if (passwordResolve) passwordResolve(true);
        } else {
            lockout.attempts++;
            if (lockout.attempts >= 5) {
                lockout.until = Date.now() + 60000; // 1ë¶„ ì°¨ë‹¨
                lockout.attempts = 0;
                localStorage.setItem('adminLockout', JSON.stringify(lockout));
                alert('âŒ ë¹„ë°€ë²ˆí˜¸ë¥¼ 5íšŒ ì—°ì† í‹€ë ¸ìŠµë‹ˆë‹¤.\në³´ì•ˆì„ ìœ„í•´ 1ë¶„ê°„ ì¬ì‹œë„ê°€ ì œí•œë©ë‹ˆë‹¤.');
                document.getElementById('password-confirm-modal').close();
            } else {
                localStorage.setItem('adminLockout', JSON.stringify(lockout));
                alert(`âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. (í‹€ë¦° íšŸìˆ˜: ${lockout.attempts}/5)`);
                input.value = '';
                input.focus();
            }
        }
    };

    // --- 9. Sound Effects ---
    let audioCtx;
    function playSound() {
        if (!audioCtx) {
            try {
                // Safari requires webkit prefix
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.error("Web Audio API is not supported in this browser.");
                return;
            }
        }
        
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.type = 'sine'; // A clean, pleasant tone
        oscillator.frequency.setValueAtTime(1046.50, audioCtx.currentTime); // C6 Note for a "ding"

        gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.05); // Quick fade-in to prevent click
        gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.3); // Fade-out

        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.3);
    }

    window.switchPage = function(element, pageId) {
        currentMode = pageId; // í˜„ì¬ ëª¨ë“œ ì„¤ì •
        const pages = document.querySelectorAll('.page');
        pages.forEach(p => p.classList.remove('active'));
        const targetPage = document.getElementById('page-' + pageId);
        if (targetPage) targetPage.classList.add('active');

        document.querySelectorAll('.btm-nav button').forEach(n => n.classList.remove('active'));
        if (element) element.classList.add('active'); // elementê°€ nullì¼ ê²½ìš° ë°©ì–´
        if (pageId === 'reports') showReports();
        if (pageId === 'home') renderInstructorManagement();
        document.getElementById('current-password').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-password').value = '';

        // [FIX] ë§ˆìŠ¤í„° ë³µêµ¬ ì½”ë“œ í‘œì‹œ ë¡œì§ ì¶”ê°€
        const masterKey = localStorage.getItem('adminMasterKey');
        const display = document.getElementById('master-key-display');
        if (display) display.innerText = masterKey || 'ë°œê¸‰ ì˜¤ë¥˜ (ìƒˆë¡œê³ ì¹¨ í•„ìš”)';

        document.getElementById('password-change-modal').showModal();
    }

    window.changePassword = function() {
        const currentPw = document.getElementById('current-password').value.trim();
        const newPw = document.getElementById('new-password').value.trim();
        const confirmPw = document.getElementById('confirm-password').value.trim();
        const storedPw = (localStorage.getItem('adminPassword') || '1234').trim();

        if (currentPw !== storedPw) return alert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        if (newPw.length < 4) return alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        if (newPw !== confirmPw) return alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');

        localStorage.setItem('adminPassword', newPw);
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        document.getElementById('password-change-modal').close();
    }

    // --- 10. App Initialization & Login ---
    window.showLoginScreen = function() {
        document.getElementById('start-screen').classList.remove('hidden');
        document.getElementById('app-main-content').classList.add('hidden');
        // [FIX] í•­ìƒ ëª¨ë“œ ì„ íƒ ë²„íŠ¼ì´ ë³´ì´ë„ë¡ ì´ˆê¸°í™”
        document.getElementById('mode-selection').classList.remove('hidden');
        document.getElementById('login-form').classList.add('hidden');
    }

    window.showAdminLogin = function() {
        document.getElementById('mode-selection').classList.add('hidden');
        document.getElementById('login-form').classList.remove('hidden');
        document.getElementById('admin-password').focus();
    }

    window.backToModeSelection = function() {
        document.getElementById('mode-selection').classList.remove('hidden');
        document.getElementById('login-form').classList.add('hidden');
    }

    window.enterMemberMode = function() {
        sessionStorage.setItem('appMode', 'member');
        showApp();
    }

    window.exitMemberMode = function() {
        sessionStorage.removeItem('appMode');
        sessionStorage.removeItem('isAdminLoggedIn');
        location.reload();
    }

    window.showApp = function() {
        const mode = sessionStorage.getItem('appMode') || (sessionStorage.getItem('isAdminLoggedIn') === 'true' ? 'admin' : null);
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('app-main-content').classList.remove('hidden');
        
        if (mode === 'member') {
            document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
            document.getElementById('btn-exit-member-mode').classList.remove('hidden');
            switchPage(null, 'member-attendance');
            
            // [FINAL FIX] DOMì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ì¬ì‹œë„í•˜ì—¬ ì´ˆê¸°í™” í•¨ìˆ˜ë¥¼ í™•ì‹¤íˆ ì‹¤í–‰
            const forceInit = (retryCount = 0) => {
                const dateInput = document.getElementById('member-mode-date');
                if (dateInput) {
                    window.syncMemberModeToNow(true); // true: ìë™ ì‹¤í–‰ ëª¨ë“œ
                    renderMemberGrid();
                } else if (retryCount < 10) { // ìµœëŒ€ 1ì´ˆê°„ ì¬ì‹œë„
                    setTimeout(() => forceInit(retryCount + 1), 100);
                }
            };
            forceInit();
        } else {
            document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
            document.getElementById('btn-exit-member-mode').classList.add('hidden');
            // ê´€ë¦¬ì ëª¨ë“œì¼ ë•ŒëŠ” í™ˆ í˜ì´ì§€ë¡œ ì´ë™ (ì•ˆì „í•˜ê²Œ ì²« ë²ˆì§¸ ë©”ë‰´ ì„ íƒ)
            const firstNavItem = document.querySelector('.nav-item');
            if (firstNavItem) switchPage(firstNavItem, 'home');
        }

        // Run initial setup that requires the DOM to be visible
        if (document.getElementById('current-url')) {
            document.getElementById('current-url').innerText = window.location.href.split('?')[0];
        }
        checkUrlForScan();
    }

    // --- íšŒì› ëª¨ë“œ ë‚ ì§œ/ìˆ˜ì—… ë™ê¸°í™” í•¨ìˆ˜ (ì™„ì „ í•´ê²° ë²„ì „) ---
    window.syncMemberModeToNow = function(isAuto = false) {
        const dateInput = document.getElementById('member-mode-date');
        const sessionSelect = document.getElementById('member-mode-session');
        const infoText = document.getElementById('current-session-info');
        const syncIcon = document.getElementById('icon-sync-member');

        if (!dateInput || !sessionSelect || !infoText) return;

        // ì‹œê°ì  í”¼ë“œë°±: ì•„ì´ì½˜ íšŒì „ (ìë™ ì‹¤í–‰ ì‹œì—ëŠ” ì œì™¸)
        if (!isAuto && syncIcon) syncIcon.classList.add('fa-spin');

        // 1ë‹¨ê³„: ë‚ ì§œ ì„¤ì • ë° ìˆ˜ì—… ëª©ë¡ ìƒì„± ëª…ë ¹
        const todayStr = window.getTodayStr();
        dateInput.value = todayStr;
        window.updateMemberModeSessionOptions();

        // 2ë‹¨ê³„: ë¸Œë¼ìš°ì €ê°€ ëª©ë¡ì„ ê·¸ë¦° í›„, ê°’ì„ ì„ íƒí•˜ë„ë¡ ìˆœì„œ ë³´ì¥
        setTimeout(() => {
            const now = new Date();
            const session = window.getCurrentSession();

            if (session && session.day === now.getDay()) {
                sessionSelect.value = session.code;
                // [NEW] Check for instructor
                const instructorName = window.instructors[session.code];
                const instructorText = instructorName ? ` (${instructorName} ì‚¬ë²”)` : '';
                infoText.innerText = `í˜„ì¬ ìˆ˜ì—…: ${session.name}${instructorText}`;
                if (!isAuto) alert(`âœ… í˜„ì¬ ì‹œê°„(${session.name})ìœ¼ë¡œ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } else {
                const dayName = window.DAYS ? window.DAYS[now.getDay()] : "";
                infoText.innerText = `í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤. (${dayName}ìš”ì¼ ${now.getHours()}ì‹œ)`;
                if (!isAuto) alert("â„¹ï¸ í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ìˆ˜ì—…ì´ ì—†ì–´ ë‚ ì§œë§Œ ì˜¤ëŠ˜ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }

            // ì•„ì´ì½˜ íšŒì „ ì¤‘ì§€
            if (!isAuto && syncIcon) setTimeout(() => syncIcon.classList.remove('fa-spin'), 500);
        }, 50); // DOM ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ìµœì†Œí•œì˜ ì§€ì—°
    };

    window.handleLogin = function() {
        const passwordField = document.getElementById('admin-password');
        const password = passwordField.value.trim();
        
        if (!password) return; 

        const storedPw = (localStorage.getItem('adminPassword') || '1234').trim();

        if (password === storedPw) {
            sessionStorage.setItem('isAdminLoggedIn', 'true');
            sessionStorage.setItem('appMode', 'admin');
            showApp();
        } else {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
            passwordField.value = '';
            passwordField.focus();
        }
    }

    window.togglePasswordVisibility = function(checkbox) {
        const passwordField = document.getElementById('admin-password');
        passwordField.type = passwordField.type === 'password' ? 'text' : 'password';
    }

    window.toggleRecoveryMode = function() {
        const isRecovery = document.getElementById('login-input-wrapper').classList.toggle('hidden');
        document.getElementById('recovery-input-wrapper').classList.toggle('hidden');
        document.getElementById('btn-admin-login').classList.toggle('hidden');
        document.getElementById('btn-admin-recovery').classList.toggle('hidden');
        
        const link = document.getElementById('link-forgot-pw');
        link.innerText = isRecovery ? "ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°" : "ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?";
    }

    window.handleMasterKeyReset = function() {
        const inputKey = document.getElementById('recovery-master-key').value.trim();
        const storedKey = localStorage.getItem('adminMasterKey');

        if (inputKey === storedKey) {
            localStorage.setItem('adminPassword', '1234');
            alert('âœ… ë¹„ë°€ë²ˆí˜¸ê°€ "1234"ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\nìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¡œ ì¦‰ì‹œ ë³€ê²½í•´ ì£¼ì„¸ìš”.');
            location.reload();
        } else {
            alert('âŒ ë³µêµ¬ ì½”ë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
    }

    // --- [NEW] Temporary Test Data Generator ---
    window.generateTestData = async function() {
        const monthInput = document.getElementById('test-data-month');
        const selectedMonth = monthInput.value; // "YYYY-MM"

        if (!selectedMonth) {
            return alert('ë°ì´í„°ë¥¼ ìƒì„±í•  ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        }

        if (!confirm(`[ì£¼ì˜] ${selectedMonth}ì›”ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì¶œì„ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }

        alert('ë°ì´í„° ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì™„ë£Œ ì‹œ ì•Œë¦¼ì´ í‘œì‹œë©ë‹ˆë‹¤. (ì•½ 10-20ì´ˆ ì†Œìš”)');

        const sampleNames = [
            "ê¹€ë¯¼ì¤€", "ì´ì„œì—°", "ë°•ë„ìœ¤", "ìµœì§€ìš°", "ì •í•˜ì¤€", "ì¡°ì„œì•„", "ìœ¤ì€ìš°", "ì¥ì‹œì•„", "ì„ì´ì¤€", "ì˜¤í•˜ìœ¤",
            "í•œì„ ìš°", "ì‹ ì§€ì•„", "ì„œìœ ì¤€", "ê¶Œì•„ìœ¤", "ê°•ì§€í˜¸", "í™©ì„œìœ¤", "ì†¡ì‹œìš°", "ì•ˆì•„ì¸", "ìœ ì§€ì•ˆ", "í™ì±„ì›",
            "ì „ë¡œí•˜", "ê³ ìˆ˜í˜¸", "ë¬¸ì´ì•ˆ", "ì–‘ì§€ìœ ", "ì†ë¡œìš´", "ë°°ì•„ë¼", "ë°±ì´í˜„", "í—ˆì„œì¤€", "ë‚¨ì†Œìœ¨", "ì‹¬ë‹¤ì€"
        ];

        const [year, month] = selectedMonth.split('-').map(Number);
        const daysInMonth = new Date(year, month, 0).getDate();
        const batch = writeBatch(db);
        let tempMembers = [...window.members]; // Use a local copy to manage new members within this run
        const generatedLogs = new Set(); // To prevent duplicate logs in this run: 'memberId-date-sessionCode'

        try {
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month - 1, day);
                const dayOfWeek = currentDate.getDay(); // 0=Sun, 6=Sat

                if (dayOfWeek === 0) continue; // Skip Sundays

                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const sessionsForDay = SESSIONS.filter(s => s.day === dayOfWeek);

                for (const session of sessionsForDay) {
                    const attendanceCount = Math.floor(Math.random() * 11) + 5; // 5 to 15 attendees
                    const shuffledNames = [...sampleNames].sort(() => 0.5 - Math.random());

                    for (let i = 0; i < attendanceCount; i++) {
                        const memberName = shuffledNames[i % shuffledNames.length];
                        let targetMember = tempMembers.find(m => m.name === memberName);

                        if (!targetMember) {
                            const newMemberRef = doc(collection(db, "members"));
                            const randomRegDay = Math.floor(Math.random() * day) + 1;
                            const regDate = new Date(year, month - 1, randomRegDay);
                            const newMemberData = { name: memberName, phone: String(Math.floor(1000 + Math.random() * 9000)), registeredAt: regDate };
                            batch.set(newMemberRef, newMemberData);
                            targetMember = { id: newMemberRef.id, ...newMemberData };
                            tempMembers.push(targetMember);
                        }

                        const logKey = `${targetMember.id}-${dateStr}-${session.code}`;
                        const alreadyExistsInDB = window.logs.some(l => l.memberId === targetMember.id && l.date === dateStr && l.sessionCode === session.code);
                        
                        if (!alreadyExistsInDB && !generatedLogs.has(logKey)) {
                            const newLogRef = doc(collection(db, "logs"));
                            batch.set(newLogRef, { memberId: targetMember.id, memberName: targetMember.name, date: dateStr, sessionCode: session.code, sessionName: session.name, timestamp: new Date(year, month - 1, day, session.start).toLocaleString() + " (í…ŒìŠ¤íŠ¸)" });
                            generatedLogs.add(logKey);
                        }
                    }
                }
            }
            await batch.commit();
            alert(`âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nì´ ${generatedLogs.size}ê°œì˜ ì¶œì„ ê¸°ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } catch (error) {
            console.error("Test data generation failed:", error);
            alert("âŒ ë°ì´í„° ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
    };

    // [FIX] Ensure Master Key exists on init
    if (!localStorage.getItem('adminMasterKey')) {
        const randomKey = Math.random().toString(36).substring(2, 10).toUpperCase();
        localStorage.setItem('adminMasterKey', `RECOVERY-${randomKey}`);
    }

    // ì•± ì´ˆê¸°í™” ì‹¤í–‰
    (function init() {
        const urlParams = new URLSearchParams(window.location.search);
        const isScanning = urlParams.has('session');
        
        // QR ìŠ¤ìº”ì„ í†µí•´ ë“¤ì–´ì˜¨ ê²½ìš°ì—ë§Œ ì¦‰ì‹œ íšŒì› ëª¨ë“œë¡œ ì§„ì…
        if (isScanning) {
            sessionStorage.setItem('appMode', 'member');
            showApp();
        }
        else showLoginScreen(); // ê·¸ ì™¸ì—ëŠ” í•­ìƒ ëª¨ë“œ ì„ íƒ í™”ë©´ í‘œì‹œ
    })();

</script>
</body>
</html>
