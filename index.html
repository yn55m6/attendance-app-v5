<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëª¸í´ê¸°ìƒí™œìš´ë™ ì—°ì‹ ë‚´ ì¶œì„ë¶€ (6ê°œì›” ì¶”ì´ ê·¸ë˜í”„)</title>
    
    <!-- [ICON SETTING] ì•„ë˜ href ì†ì„±ì˜ URLì„ ì›í•˜ëŠ” ì´ë¯¸ì§€ ì£¼ì†Œë‚˜ Base64 ë°ì´í„°ë¡œ ë³€ê²½í•˜ì„¸ìš” -->
    <link rel="icon" id="app-favicon" href="https://cdn-icons-png.flaticon.com/512/3472/3472130.png">
    <link rel="apple-touch-icon" id="app-apple-icon" href="https://cdn-icons-png.flaticon.com/512/3472/3472130.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Chart.js (ê·¸ë˜í”„ìš©) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js DataLabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; background-color: #f3f4f6; }
        .app-container { max-width: 1024px; margin: 0 auto; background: white; min-height: 100vh; position: relative; padding-bottom: 80px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        /* ë„¤ë¹„ê²Œì´ì…˜ ë°” */
        .nav-bar { position: fixed; bottom: 0; width: 100%; max-width: 1024px; background: white; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-around; padding: 12px 0; z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #9ca3af; font-size: 0.75rem; cursor: pointer; }
        .nav-item.active { color: #4f46e5; }
        
        /* í˜ì´ì§€ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ */
        .page { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 16px; border: 1px solid #f3f4f6; }
        .btn-primary { background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; text-align: center; cursor: pointer; transition: 0.2s; }
        .btn-primary:active { transform: scale(0.98); }

        /* ë¦¬í¬íŠ¸ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .report-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .report-table th { background: #f9fafb; padding: 8px; border-bottom: 2px solid #e5e7eb; text-align: left; font-weight: bold; color: #374151; white-space: nowrap; }
        .report-table td { padding: 8px; border-bottom: 1px solid #f3f4f6; color: #4b5563; }
        .report-table tr:last-child td { border-bottom: none; }

        /* ì¸ì‡„ ëª¨ë“œ ì„¤ì • */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- NEW: Mode Selection & Login Modal -->
    <div id="start-screen" class="absolute inset-0 bg-gray-100 z-50 flex flex-col justify-center items-center p-6">
        <div id="mode-selection" class="w-full max-w-md text-center">
            <h1 class="text-3xl font-bold text-indigo-600 mb-8">ëª¸í´ê¸°ìƒí™œìš´ë™<br>ì—°ì‹ ë‚´ ì¶œì„ë¶€</h1>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button onclick="enterMemberMode()" class="p-8 bg-white border-2 border-indigo-500 rounded-2xl shadow-lg hover:bg-indigo-50 transition">
                    <i class="fas fa-user-check text-4xl text-indigo-500 mb-3"></i>
                    <p class="text-2xl font-bold text-gray-800">íšŒì› ì¶œì„ìš©</p>
                    <p class="text-sm text-gray-500 mt-1">íŒ¨ìŠ¤ì›Œë“œ ì—†ì´ ë°”ë¡œ ì¶œì„</p>
                </button>
                <button onclick="showAdminLogin()" class="p-8 bg-gray-800 text-white rounded-2xl shadow-lg hover:bg-gray-700 transition">
                    <i class="fas fa-user-shield text-4xl mb-3"></i>
                    <p class="text-2xl font-bold">ê´€ë¦¬ì ëª¨ë“œ</p>
                    <p class="text-sm text-gray-400 mt-1">ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ìš”</p>
                </button>
            </div>
        </div>

        <div id="login-form" class="w-full max-w-xs text-center hidden">
            <button onclick="backToModeSelection()" class="mb-8 text-gray-400 hover:text-gray-600"><i class="fas fa-arrow-left mr-2"></i>ë’¤ë¡œê°€ê¸°</button>
            <i class="fas fa-lock text-4xl text-gray-400 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
            <p class="text-sm text-gray-500 mb-6">ê³„ì†í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="password" id="admin-password" class="w-full p-3 text-center text-lg border-2 rounded-lg mb-4" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeyup="if(event.key==='Enter') handleLogin()" autocomplete="current-password">
            <label class="flex items-center justify-center text-xs text-gray-500 mb-6 cursor-pointer">
                <input type="checkbox" onchange="window.togglePasswordVisibility(this)" class="mr-2">
                ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ
            </label>
            <button onclick="handleLogin()" class="btn-primary">ë¡œê·¸ì¸</button>
        </div>
    </div>

    <!-- Main App Wrapper -->
    <div id="app-main-content" class="hidden">
        <!-- Header -->
        <header class="bg-indigo-600 text-white p-4 sticky top-0 z-40 shadow-md flex justify-between items-center no-print">
            <h1 class="text-lg font-bold"><i class="fas fa-check-circle mr-2"></i>ëª¸í´ê¸°ìƒí™œìš´ë™ ì—°ì‹ ë‚´ ì¶œì„ë¶€</h1>
            <div class="flex gap-2">
                <button id="btn-exit-member-mode" onclick="exitMemberMode()" class="hidden text-xs bg-red-500 px-2 py-1 rounded hover:bg-red-600">ëª¨ë“œ ì¢…ë£Œ</button>
                <button onclick="resetData()" class="admin-only text-xs bg-indigo-800 px-2 py-1 rounded hover:bg-indigo-700">ì´ˆê¸°í™”</button>
            </div>
        </header>

        <!-- Page: Member Attendance (New) -->
        <div id="page-member-attendance" class="page">
            <div class="card text-center py-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">ë°˜ê°‘ìŠµë‹ˆë‹¤! ğŸ‘‹</h2>
                <p id="current-session-info" class="text-indigo-600 font-bold text-lg mb-4">í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ìˆ˜ì—…ì„ ì°¾ëŠ” ì¤‘...</p>

                <!-- [NEW] Date & Session Selection for Member Mode -->
                <div class="grid grid-cols-2 gap-2 mb-6 max-w-md mx-auto px-2">
                    <div class="text-left">
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">ì¶œì„ ë‚ ì§œ</label>
                        <input type="date" id="member-mode-date" class="w-full p-3 border-2 border-gray-100 rounded-xl bg-gray-50 text-sm font-bold text-gray-700 focus:border-indigo-300 outline-none" onchange="updateMemberModeSessionOptions()">
                    </div>
                    <div class="text-left">
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">ìˆ˜ì—…(ì°¨ìˆ˜) ì„ íƒ</label>
                        <select id="member-mode-session" class="w-full p-3 border-2 border-gray-100 rounded-xl bg-gray-50 text-sm font-bold text-gray-700 focus:border-indigo-300 outline-none"></select>
                    </div>
                </div>
                
                <div class="relative mb-6">
                    <input type="text" id="member-search-input" oninput="renderMemberGrid(this.value)" 
                           placeholder="ì´ë¦„ ë˜ëŠ” ì´ˆì„± ê²€ìƒ‰ (ì˜ˆ: ã„±ã„·ã…)" 
                           class="w-full p-4 text-xl border-2 border-indigo-200 rounded-xl focus:border-indigo-500 outline-none shadow-inner">
                    <i class="fas fa-search absolute right-4 top-5 text-gray-300 text-xl"></i>
                </div>

                <div id="member-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 max-h-[50vh] overflow-y-auto p-2">
                    <!-- Member buttons will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Page 1: Home (QR & Tools) -->
        <div id="page-home" class="page">
            <div class="card">
                <h2 class="text-gray-800 font-bold text-lg mb-2">ğŸ–¨ï¸ QR ì½”ë“œ ê´€ë¦¬</h2>
                <p class="text-sm text-gray-500 mb-4">ê°•ì˜ì‹¤ ë¶€ì°©ìš© QR ì½”ë“œë¥¼ ì¸ì‡„í•˜ì„¸ìš”.</p>
                <button onclick="openQRPrintModal()" class="w-full py-3 bg-gray-800 text-white rounded-lg font-bold hover:bg-gray-700">
                    <i class="fas fa-print mr-2"></i>QR ì½”ë“œ ëª©ë¡ ë³´ê¸°
                </button>
            </div>

            <div class="card">
                <h3 class="font-bold text-gray-700 mb-3">ğŸ›  ê´€ë¦¬ì ë„êµ¬</h3>
                <button onclick="openPaperInputModal()" class="btn-primary mb-2 bg-gradient-to-r from-green-500 to-emerald-600">
                    <i class="fas fa-edit mr-2"></i>ì¢…ì´ ëª…ë¶€ ì…ë ¥ (í…ìŠ¤íŠ¸)
                </button>
                <p class="text-xs text-gray-400 mt-1">
                    * ì´ë¦„ë§Œ ì…ë ¥í•˜ë©´ ìë™ ê°€ì…/ì¶œì„ ì²˜ë¦¬ë©ë‹ˆë‹¤.<br>
                    * ë™ëª…ì´ì¸ì€ <strong>ì´ë¦„ ë²ˆí˜¸ë’·ìë¦¬</strong> (ì˜ˆ: ê¹€ì² ìˆ˜ 1234)
                </p>
                <button onclick="openPasswordChangeModal()" class="w-full mt-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-bold hover:bg-gray-200 border border-gray-200">
                    <i class="fas fa-key mr-2"></i>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                </button>
            </div>
            
            <div class="text-center text-xs text-gray-400 mt-4">
                í˜„ì¬ ì ‘ì† ì£¼ì†Œ:<br>
                <span id="current-url" class="text-indigo-500 break-all"></span>
            </div>
        </div>

        <!-- Page 2: Members -->
        <div id="page-members" class="page">
            <div class="card">
                <h2 class="font-bold text-lg mb-4">íšŒì› ë“±ë¡</h2>
                <div class="flex gap-2 mb-2">
                    <input type="text" id="new-member-name" placeholder="ì´ë¦„ (í•„ìˆ˜)" class="flex-1 p-2 border rounded bg-gray-50">
                    <input type="tel" id="new-member-phone" placeholder="ë’·ë²ˆí˜¸ (ìƒëµê°€ëŠ¥)" class="w-1/3 p-2 border rounded bg-gray-50 text-sm">
                </div>
                <button onclick="addMember()" class="btn-primary text-sm">ë“±ë¡í•˜ê¸°</button>
            </div>
            <div class="card">
                <h2 class="font-bold text-lg mb-2">íšŒì› ëª©ë¡ <span id="member-count" class="text-sm text-indigo-600 font-normal"></span></h2>
                <p class="text-xs text-gray-400 mb-2">* ì´ë¦„ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ì´ë ¥ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <ul id="member-list" class="divide-y divide-gray-100"></ul>
            </div>
        </div>

        <!-- Page 3: Reports (Tables & Chart) -->
        <div id="page-reports" class="page">
            <div class="bg-white p-4 sticky top-14 z-30 shadow-sm mb-4 -mx-5 px-5 border-b">
                <label class="text-xs font-bold text-gray-500 block mb-1">ì¡°íšŒ ì›” ì„ íƒ</label>
                <input type="month" id="report-month" class="w-full p-2 border rounded bg-gray-50 font-bold text-gray-700" onchange="renderReports()">
            </div>

            <!-- Report 0: ì›”ê°„ ì´ ì¶œì„ ì¸ì› & ê·¸ë˜í”„ (NEW) -->
            <div class="card bg-white border border-gray-200">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <h2 class="font-bold text-lg text-gray-800">ğŸ“Š ì›”ê°„ ì´ ì¶œì„</h2>
                        <p class="text-xs text-gray-400">ì¤‘ë³µ ì œì™¸, ì‹¤ì œ ì¶œì„ íšŒì› ìˆ˜</p>
                    </div>
                    <span id="report-total-unique" class="text-4xl font-bold text-indigo-600">0ëª…</span>
                </div>
                
                <!-- 6ê°œì›” ì¶”ì´ ê·¸ë˜í”„ -->
                <div class="h-48 w-full">
                    <canvas id="trendChart"></canvas>
                </div>
                <p class="text-center text-xs text-gray-400 mt-2">ìµœê·¼ 6ê°œì›” ì¶œì„ ì¶”ì´</p>
            </div>

            <!-- NEW: ì°¨ìˆ˜ë³„ ì£¼ê°„ ì¶œì„ í˜„í™© -->
            <div class="card">
                <h2 class="font-bold text-lg mb-2 text-green-700">ğŸ“… ì°¨ìˆ˜ë³„ ì£¼ê°„ ì¶œì„</h2>
                <div class="overflow-x-auto">
                    <table class="report-table" style="min-width: 320px;">
                        <thead>
                            <tr>
                                <th>ì°¨ìˆ˜(ë°˜)</th>
                                <th class="text-center">1ì£¼</th>
                                <th class="text-center">2ì£¼</th>
                                <th class="text-center">3ì£¼</th>
                                <th class="text-center">4ì£¼</th>
                                <th class="text-center">5ì£¼</th>
                                <th class="text-right">ê³„</th>
                            </tr>
                        </thead>
                        <tbody id="report-session-weekly-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Report 3: ì›”ë³„ ê°œì¸ë³„ ì£¼ì°¨ë³„ íšŸìˆ˜ -->
            <div class="card">
                <h2 class="font-bold text-lg mb-2 text-blue-700">ğŸ‘¤ ê°œì¸ë³„ ì£¼ê°„ ì¶œì„</h2>
                <p class="text-xs text-gray-400 mb-2">* ì´ë¦„ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ë‚ ì§œë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div class="overflow-x-auto">
                    <table class="report-table" style="min-width: 320px;">
                        <thead>
                            <tr>
                                <th>ì´ë¦„</th>
                                <th class="text-center">1ì£¼</th>
                                <th class="text-center">2ì£¼</th>
                                <th class="text-center">3ì£¼</th>
                                <th class="text-center">4ì£¼</th>
                                <th class="text-center">5ì£¼</th>
                                <th class="text-right">ê³„</th>
                            </tr>
                        </thead>
                        <tbody id="report-weekly-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Report 1: ì›”ë³„ íšŒì›ë³„ ì¶œì„íšŸìˆ˜ -->
            <div class="card">
                <h2 class="font-bold text-lg mb-2 text-indigo-700">ğŸ† íšŒì›ë³„ ì¶œì„ ìˆœìœ„</h2>
                <div class="overflow-x-auto">
                    <table class="report-table">
                        <thead><tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ì „í™”ë²ˆí˜¸</th><th class="text-right">íšŸìˆ˜</th></tr></thead>
                        <tbody id="report-member-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Navigation Bar -->
        <nav class="nav-bar no-print admin-only">
            <div class="nav-item active" onclick="switchPage(this, 'home')">
                <i class="fas fa-home"></i><span>í™ˆ</span>
            </div>
            <div class="nav-item" onclick="switchPage(this, 'members')">
                <i class="fas fa-users"></i><span>íšŒì›ê´€ë¦¬</span>
            </div>
            <div class="nav-item" onclick="switchPage(this, 'reports')">
                <i class="fas fa-chart-bar"></i><span>ë¦¬í¬íŠ¸</span>
            </div>
        </nav>
    </div>
</div>

<!-- Modal: QR Print View -->
<div id="qr-print-modal" class="fixed inset-0 bg-white z-50 hidden overflow-y-auto">
    <div class="p-6 max-w-2xl mx-auto" id="print-area">
        <div class="flex justify-between items-center mb-6 no-print">
            <h2 class="text-2xl font-bold">ì¸ì‡„ìš© QR ì½”ë“œ</h2>
            <button onclick="closeQRPrintModal()" class="text-gray-500 text-lg"><i class="fas fa-times"></i></button>
        </div>
        <div class="no-print mb-4 text-center">
            <button onclick="window.print()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-blue-700">
                <i class="fas fa-print mr-2"></i>ì¸ì‡„í•˜ê¸°
            </button>
            <p class="text-xs text-red-500 mt-2">â€» ì£¼ì˜: ì´ QR ì½”ë“œëŠ” í˜„ì¬ ì›¹ì‚¬ì´íŠ¸ ì£¼ì†Œ ê¸°ë°˜ì…ë‹ˆë‹¤.<br>ì„œë²„ ì£¼ì†Œê°€ ë°”ë€Œë©´ ë‹¤ì‹œ ì¶œë ¥í•´ì•¼ í•©ë‹ˆë‹¤.</p>
        </div>
        <div id="static-qr-list" class="grid grid-cols-1 md:grid-cols-2 gap-8 text-center"></div>
    </div>
</div>

<!-- Modal: Paper Input (Text Area) -->
<div id="paper-input-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex flex-col justify-center items-center p-6 no-print">
    <div class="bg-white w-full max-w-md rounded-xl p-6 relative">
        <button onclick="closePaperInputModal()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
        
        <h3 class="text-xl font-bold mb-2 text-green-700"><i class="fas fa-edit mr-2"></i>ì¢…ì´ ëª…ë¶€ ì…ë ¥</h3>
        
        <div class="mb-3">
            <label class="block text-xs font-bold text-gray-500 mb-1">1. ë‚ ì§œ ì„ íƒ</label>
            <input type="date" id="paper-date" class="w-full p-2 border rounded bg-gray-50 font-bold text-gray-700" onchange="updateSessionOptions()">
        </div>

        <div class="mb-3">
            <label class="block text-xs font-bold text-gray-500 mb-1">2. ì‹œê°„(ì°¨ìˆ˜) ì„ íƒ</label>
            <select id="paper-session-select" class="w-full p-2 border rounded bg-gray-50 text-sm font-bold">
                <!-- JSë¡œ ì˜µì…˜ ì±„ì›€ -->
            </select>
        </div>

        <div class="mb-4">
            <label class="block text-xs font-bold text-gray-500 mb-1">3. ëª…ë‹¨ ì…ë ¥ (ì´ë¦„ë§Œ ì…ë ¥ ê°€ëŠ¥)</label>
            <textarea id="paper-text-area" class="w-full h-32 p-3 border rounded bg-gray-50 text-sm font-mono" placeholder="ê¹€ì² ìˆ˜&#13;&#10;ì´ì˜í¬&#13;&#10;ë°•ë¯¼ìˆ˜ 5678"></textarea>
            <p class="text-xs text-indigo-500 mt-1">* ì—†ëŠ” íšŒì›ì€ ìë™ ê°€ì…ë©ë‹ˆë‹¤.</p>
        </div>
        
        <div class="flex gap-2">
            <button onclick="processPaperInput()" class="flex-1 btn-primary bg-green-600">ì¼ê´„ ì¶œì„ ì²˜ë¦¬</button>
            <button onclick="closePaperInputModal()" class="w-1/3 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<!-- Modal: User Attendance Check (QR Scan Result) -->
<div id="user-check-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex flex-col justify-center items-center p-6 no-print">
    <div class="bg-white w-full max-w-sm rounded-xl p-6 text-center">
        <h3 class="text-2xl font-bold mb-4 text-indigo-600">ì¶œì„ ì²´í¬</h3>
        
        <!-- Date & Session Adjustment -->
        <div class="grid grid-cols-2 gap-2 mb-4">
            <div class="text-left">
                <label class="block text-[10px] font-bold text-gray-400 mb-1">ì¶œì„ ë‚ ì§œ</label>
                <input type="date" id="check-date" class="w-full p-2 border rounded bg-gray-50 text-sm font-bold text-gray-700" onchange="updateCheckSessionOptions()">
            </div>
            <div class="text-left">
                <label class="block text-[10px] font-bold text-gray-400 mb-1">ìˆ˜ì—…(ì°¨ìˆ˜) ì„ íƒ</label>
                <select id="check-session-select" class="w-full p-2 border rounded bg-gray-50 text-sm font-bold text-gray-700"></select>
            </div>
        </div>

        <!-- Manual Input (Default View) -->
        <div id="check-manual-wrapper">
            <input type="text" id="check-manual-name" placeholder="ì´ë¦„ ì…ë ¥" class="w-full p-4 border-2 border-indigo-200 rounded-xl mb-3 bg-white text-2xl font-bold text-center placeholder-gray-300 focus:border-indigo-500 outline-none h-16">
            <input type="tel" id="check-manual-phone" placeholder="ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ (ì„ íƒ)" class="w-full p-4 border rounded-xl mb-4 bg-gray-50 text-xl text-center h-14">
            
            <div onclick="toggleCheckMode('existing')" class="w-full py-3 bg-gray-100 text-gray-600 rounded-xl font-bold cursor-pointer hover:bg-gray-200 mb-4 text-base border border-gray-200">
                ğŸ” ì „ì²´ ëª…ë‹¨ì—ì„œ ì„ íƒí•˜ê¸°
            </div>
        </div>

        <!-- Existing Member Select (Hidden by default) -->
        <div id="check-existing-wrapper" class="hidden">
            <select id="check-user-select" class="w-full p-4 border-2 border-indigo-100 rounded-xl mb-4 bg-white text-xl font-bold text-gray-800 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none h-16">
                <option value="">â¬‡ï¸ ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ ì´ë¦„ ì„ íƒ</option>
            </select>
            <div onclick="toggleCheckMode('manual')" class="w-full py-4 bg-indigo-50 text-indigo-700 rounded-xl font-bold cursor-pointer hover:bg-indigo-100 mb-4 text-lg border border-indigo-100 shadow-sm flex items-center justify-center">
                <span>âŒ¨ï¸ ì§ì ‘ ì…ë ¥ìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
            </div>
        </div>

        <button onclick="confirmAttendance()" class="btn-primary mb-2 text-xl py-4 shadow-lg">âœ… ì¶œì„ í™•ì¸</button>
        <button onclick="closeCheckModal()" class="text-gray-500 text-base mt-4 underline p-2">ì·¨ì†Œ</button>
    </div>
</div>

<!-- Modal: Member History -->
<div id="history-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex flex-col justify-center items-center p-6 no-print">
    <div class="bg-white w-full max-w-sm rounded-xl p-6 relative max-h-[80vh] flex flex-col">
        <button onclick="closeHistoryModal()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
        
        <h3 class="text-xl font-bold mb-1 text-indigo-700" id="history-member-name">íšŒì› ì´ë¦„</h3>
        <p class="text-xs text-gray-500 mb-4">ìƒì„¸ ì¶œì„ ì´ë ¥ (ìµœì‹ ìˆœ)</p>
        
        <div class="overflow-y-auto flex-1 border-t border-gray-100 pt-2">
            <ul id="history-list" class="text-sm space-y-3">
                <!-- History items will go here -->
            </ul>
        </div>
        
        <button onclick="closeHistoryModal()" class="mt-4 w-full py-2 bg-gray-100 text-gray-600 rounded text-sm font-bold">ë‹«ê¸°</button>
    </div>
</div>

<!-- Modal: Change Password -->
<div id="password-change-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex flex-col justify-center items-center p-6 no-print">
    <div class="bg-white w-full max-w-xs rounded-xl p-6 relative">
        <button onclick="closePasswordChangeModal()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
        <h3 class="text-xl font-bold mb-4 text-gray-800">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
        
        <input type="password" id="current-password" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" class="w-full p-3 border rounded mb-2 bg-gray-50">
        <input type="password" id="new-password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" class="w-full p-3 border rounded mb-2 bg-gray-50">
        <input type="password" id="confirm-password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" class="w-full p-3 border rounded mb-4 bg-gray-50">
        
        <button onclick="changePassword()" class="btn-primary">ë³€ê²½í•˜ê¸°</button>

        <div class="mt-6 p-3 bg-orange-50 border border-orange-100 rounded-lg text-left">
            <p class="text-[10px] font-bold text-orange-400 uppercase mb-1">ë§ˆìŠ¤í„° ë³µêµ¬ ì½”ë“œ (ë¶„ì‹¤ ëŒ€ë¹„)</p>
            <p id="master-key-display" class="text-sm font-mono font-bold text-orange-700 break-all select-all"></p>
            <p class="text-[9px] text-orange-400 mt-1">* ë¹„ë°€ë²ˆí˜¸ ë¶„ì‹¤ ì‹œ ì´ ì½”ë“œë¡œ ì´ˆê¸°í™”ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë”°ë¡œ ê¸°ë¡í•´ ë‘ì„¸ìš”.</p>
        </div>
    </div>
</div>

<!-- Modal: Session Attendees -->
<div id="session-attendees-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex flex-col justify-center items-center p-6 no-print">
    <div class="bg-white w-full max-w-sm rounded-xl p-6 relative max-h-[80vh] flex flex-col">
        <button onclick="closeSessionAttendeesModal()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
        
        <h3 class="text-xl font-bold mb-1 text-green-700" id="session-attendees-title">ì„¸ì…˜ ì°¸ì„ì ëª…ë‹¨</h3>
        <p class="text-xs text-gray-500 mb-4" id="session-attendees-subtitle">ì›”ê°„ ì´ ì°¸ì„ì (ì¤‘ë³µ ì œì™¸)</p>
        
        <div class="overflow-y-auto flex-1 border-t border-gray-100 pt-2">
            <ul id="session-attendees-list" class="text-sm space-y-2">
                <!-- Attendee names will go here -->
            </ul>
        </div>
        
        <button onclick="closeSessionAttendeesModal()" class="mt-4 w-full py-2 bg-gray-100 text-gray-600 rounded text-sm font-bold">ë‹«ê¸°</button>
    </div>
</div>

<!-- Modal: Password Confirmation for Sensitive Actions -->
<div id="password-confirm-modal" class="fixed inset-0 bg-black bg-opacity-90 z-[60] hidden flex flex-col justify-center items-center p-6 no-print">
    <div class="bg-white w-full max-w-xs rounded-xl p-6 text-center">
        <h3 class="text-xl font-bold mb-2 text-red-600">ğŸ” ë³´ì•ˆ í™•ì¸</h3>
        <p class="text-sm text-gray-500 mb-4">ë¯¼ê°í•œ ì‘ì—…ì„ ìœ„í•´<br>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
        <input type="password" id="confirm-pw-input" class="w-full p-3 text-center text-lg border-2 rounded-lg mb-4" placeholder="â€¢â€¢â€¢â€¢" onkeyup="if(event.key==='Enter') handlePasswordConfirm()">
        <div class="flex gap-2">
            <button onclick="handlePasswordConfirm()" class="flex-1 btn-primary">í™•ì¸</button>
            <button onclick="closePasswordConfirmModal()" class="w-1/3 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script type="module">
    // --- 0. Firebase Setup ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // TODO: Firebase Consoleì—ì„œ ë°œê¸‰ë°›ì€ ì„¤ì •ê°’ì„ ì•„ë˜ì— ì…ë ¥í•´ì£¼ì„¸ìš”.
    const firebaseConfig = {
        apiKey: "AIzaSyBeO3VsRM8x7pY9A5tktrUDIZPfCMKGZfQ",
        authDomain: "smart-attendance-964dc.firebaseapp.com",
        projectId: "smart-attendance-964dc",
        storageBucket: "smart-attendance-964dc.firebasestorage.app",
        messagingSenderId: "409196393524",
        appId: "1:409196393524:web:f705254e8e62c415488661"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- 1. Configuration ---
    // [CHANGED] Use localStorage for password persistence. Default is '1234'.
    const initAdminPw = () => {
        const pw = localStorage.getItem('adminPassword');
        if (!pw || pw.trim() === "" || pw === 'undefined' || pw === 'null') {
            localStorage.setItem('adminPassword', '1234');
        }
    };
    initAdminPw();
    
    // Register ChartDataLabels plugin globally
    Chart.register(ChartDataLabels);

    window.SESSIONS = [];
    window.DAYS = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
    window.TIMES = [
        { id: "AM", name: "ì˜¤ì „ë°˜", start: 6, end: 12 },
        { id: "PM", name: "ì˜¤í›„ë°˜", start: 12, end: 18 },
        { id: "EVE", name: "ì €ë…ë°˜", start: 18, end: 24 }
    ];

    // ì›”~ê¸ˆ ìƒì„±
    for(let d=1; d<=5; d++) {
        TIMES.forEach(t => {
            SESSIONS.push({ code: `D${d}_${t.id}`, name: `${DAYS[d]}ìš”ì¼ ${t.name}`, day: d, start: t.start, end: t.end });
        });
    }
    // í† ìš”ì¼ ì˜¤í›„ë°˜ ì¶”ê°€
    SESSIONS.push({ code: "D6_PM", name: "í† ìš”ì¼ ì˜¤í›„ë°˜", day: 6, start: 12, end: 18 });

    // --- 2. Data Management ---
    // Local state for rendering (synced with Firebase)
    window.members = [];
    window.logs = [];
    let currentScanSession = null;
    let trendChartInstance = null; // Chart instance

    // Real-time Listeners
    // 1. Members
    onSnapshot(query(collection(db, "members"), orderBy("name")), (snapshot) => {
        window.members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderMembers();
        updateCheckUserSelect(); // [FIX] íšŒì› ë°ì´í„° ë³€ê²½ ì‹œ, ì¶œì„ ëª¨ë‹¬ì˜ ë“œë¡­ë‹¤ìš´ë„ í•­ìƒ ì—…ë°ì´íŠ¸
        renderMemberGrid(); // íšŒì› ì¶œì„ ëª¨ë“œ ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
    });

    // 2. Logs
    onSnapshot(query(collection(db, "logs"), orderBy("timestamp", "desc")), (snapshot) => {
        window.logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderReports();
    });

    // [NEW] Helper function to populate the attendance check dropdown
    function updateCheckUserSelect() {
        const select = document.getElementById('check-user-select');
        const currentValue = select.value; // Preserve selection if possible

        select.innerHTML = '<option value="">â¬‡ï¸ ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ ì´ë¦„ ì„ íƒ</option>'; 
        
        window.members.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.id;
            opt.innerText = `${m.name} (${m.phone})`;
            select.appendChild(opt);
        });
        
        if (currentValue && window.members.some(m => m.id === currentValue)) {
            select.value = currentValue;
        }
    }

    // [NEW] Choseong Search Logic
    const getChoseong = (str) => {
        const choseong = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
        let result = "";
        for(let i=0; i<str.length; i++) {
            const code = str.charCodeAt(i) - 44032;
            if(code > -1 && code < 11172) result += choseong[Math.floor(code/588)];
            else result += str.charAt(i);
        }
        return result;
    };

    window.renderMemberGrid = function(query = "") {
        const grid = document.getElementById('member-grid');
        if (!grid) return;
        
        const filtered = members.filter(m => 
            m.name.includes(query) || getChoseong(m.name).includes(query)
        );

        grid.innerHTML = filtered.map(m => `
            <button onclick="handleMemberGridClick('${m.id}')" 
                    class="p-4 bg-white border-2 border-indigo-100 rounded-xl shadow-sm active:bg-indigo-50 active:scale-95 transition flex flex-col items-center justify-center min-h-[100px]">
                <span class="text-xl font-bold text-gray-800">${m.name}</span>
                <span class="text-xs text-gray-400 mt-1">${m.phone === '0000' ? '' : m.phone}</span>
            </button>
        `).join('');
        
        if (filtered.length === 0) {
            grid.innerHTML = `<div class="col-span-full py-10 text-gray-400">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        }
    }

    window.handleMemberGridClick = function(memberId) {
        const dateStr = document.getElementById('member-mode-date').value;
        const sessionCode = document.getElementById('member-mode-session').value;
        const member = members.find(m => m.id === memberId);
        const session = SESSIONS.find(s => s.code === sessionCode);

        if (!session || sessionCode === "ìˆ˜ì—… ì—†ìŒ") {
            return alert("ì„ íƒëœ ë‚ ì§œì— ì§„í–‰ë˜ëŠ” ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤. ë‚ ì§œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }

        if (confirm(`[${session.name}]\n${member.name}ë‹˜, ì¶œì„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            confirmAttendanceWithId(memberId, false, dateStr, sessionCode);
        }
    }

    // --- 3. Helper Functions ---
    window.getWeekOfMonth = function(dateStr) {
        const d = new Date(dateStr);
        const date = d.getDate();
        const firstDayOfMonth = new Date(d.getFullYear(), d.getMonth(), 1).getDay();
        return Math.ceil((date + firstDayOfMonth) / 7);
    }

    window.getCurrentSession = function() {
        const now = new Date();
        const day = now.getDay();
        const hour = now.getHours();
        return SESSIONS.find(s => s.day === day && hour >= s.start && hour < s.end);
    }

    window.updateMemberModeSessionOptions = function() {
        const dateStr = document.getElementById('member-mode-date').value;
        const date = new Date(dateStr);
        const day = date.getDay();
        const select = document.getElementById('member-mode-session');
        select.innerHTML = '';
        const availableSessions = SESSIONS.filter(s => s.day === day);
        availableSessions.forEach(s => {
            const opt = document.createElement('option'); opt.value = s.code; opt.innerText = s.name; select.appendChild(opt);
        });
        if(availableSessions.length === 0) {
            const opt = document.createElement('option'); opt.innerText = "ìˆ˜ì—… ì—†ìŒ"; select.appendChild(opt);
        }
    }

    // --- 4. Report Logic ---
    window.renderReports = function() {
        const monthInput = document.getElementById('report-month');
        if (!monthInput.value) {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            monthInput.value = `${yyyy}-${mm}`;
        }
        
        const selectedMonth = monthInput.value; // "YYYY-MM"
        const monthlyLogs = logs.filter(log => log.date.startsWith(selectedMonth));

        // [Report 0] ì›”ê°„ ì´ ì¶œì„ ì¸ì› (Unique Count) & Chart
        const uniqueMembers = new Set(monthlyLogs.map(log => log.memberId)).size;
        document.getElementById('report-total-unique').innerText = `${uniqueMembers}ëª…`;
        
        // Render Chart
        renderTrendChart(selectedMonth);

        // [Report 1] ì›”ë³„ íšŒì›ë³„ ì¶œì„íšŸìˆ˜
        const memberCounts = {};
        monthlyLogs.forEach(log => {
            if (!memberCounts[log.memberId]) {
                const m = members.find(mem => mem.id === log.memberId);
                memberCounts[log.memberId] = { count: 0, name: log.memberName, phone: m ? m.phone : "" };
            }
            memberCounts[log.memberId].count++;
        });
        const sortedMembers = Object.values(memberCounts).sort((a, b) => b.count - a.count);
        
        const tbody1 = document.getElementById('report-member-body');
        tbody1.innerHTML = '';
        if (sortedMembers.length === 0) tbody1.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        else {
            sortedMembers.forEach((item, index) => {
                tbody1.innerHTML += `<tr><td>${index + 1}</td><td class="font-bold">${item.name}</td><td class="text-xs text-gray-400">${item.phone}</td><td class="text-right font-bold text-indigo-600">${item.count}íšŒ</td></tr>`;
            });
        }

        // [NEW] ì°¨ìˆ˜ë³„ ì£¼ê°„ ì¶œì„ í˜„í™©
        const sessionWeeklyCounts = {};
        monthlyLogs.forEach(log => {
            const week = getWeekOfMonth(log.date);
            const sessionName = log.sessionName;
            if (!sessionWeeklyCounts[sessionName]) {
                sessionWeeklyCounts[sessionName] = { 
                    name: sessionName, 
                    weeks: {1:0, 2:0, 3:0, 4:0, 5:0}, 
                    total: 0 
                };
            }
            if (sessionWeeklyCounts[sessionName].weeks[week] !== undefined) {
                sessionWeeklyCounts[sessionName].weeks[week]++;
            }
            sessionWeeklyCounts[sessionName].total++;
        });
        
        const tbody2 = document.getElementById('report-session-weekly-body');
        tbody2.innerHTML = '';
        const sortedSessionWeekly = Object.values(sessionWeeklyCounts).sort((a, b) => {
            const indexA = SESSIONS.findIndex(s => s.name === a.name);
            const indexB = SESSIONS.findIndex(s => s.name === b.name);
            return indexA - indexB;
        });
        if (sortedSessionWeekly.length === 0) tbody2.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        else {
            sortedSessionWeekly.forEach(item => {
                const weekCells = [1, 2, 3, 4, 5].map(weekNum => {
                    const count = item.weeks[weekNum];
                    return count > 0
                        ? `<td class="text-center text-gray-500 cursor-pointer underline" onclick="openSessionAttendeesModal('${item.name}', ${weekNum})">${count}</td>`
                        : `<td class="text-center text-gray-500">-</td>`;
                }).join('');

                const totalCell = item.total > 0
                    ? `<td class="text-right font-bold text-blue-600 cursor-pointer underline" onclick="openSessionAttendeesModal('${item.name}', null)">${item.total}</td>`
                    : `<td class="text-right font-bold text-blue-600">${item.total}</td>`;

                tbody2.innerHTML += `<tr>
                    <td class="font-bold text-green-700">${item.name}</td>
                    ${weekCells}
                    ${totalCell}
                </tr>`;
            });
        }

        // [Report 3] ì›”ë³„ ê°œì¸ë³„ ì£¼ì°¨ë³„ íšŸìˆ˜
        const individualWeekly = {};
        monthlyLogs.forEach(log => {
            const week = getWeekOfMonth(log.date);
            if (!individualWeekly[log.memberId]) {
                individualWeekly[log.memberId] = { 
                    id: log.memberId, 
                    name: log.memberName, 
                    weeks: {1:0, 2:0, 3:0, 4:0, 5:0}, 
                    total: 0 
                };
            }
            if (individualWeekly[log.memberId].weeks[week] !== undefined) individualWeekly[log.memberId].weeks[week]++;
            individualWeekly[log.memberId].total++;
        });

        const tbody3 = document.getElementById('report-weekly-body');
        tbody3.innerHTML = '';
        const sortedIndiv = Object.values(individualWeekly).sort((a, b) => a.name.localeCompare(b.name));
        if (sortedIndiv.length === 0) tbody3.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        else {
            sortedIndiv.forEach(item => {
                tbody3.innerHTML += `<tr>
                    <td class="font-bold text-indigo-600 cursor-pointer hover:underline" onclick="openHistoryModal('${item.id}')">${item.name}</td>
                    <td class="text-center text-gray-500">${item.weeks[1] || '-'}</td>
                    <td class="text-center text-gray-500">${item.weeks[2] || '-'}</td>
                    <td class="text-center text-gray-500">${item.weeks[3] || '-'}</td>
                    <td class="text-center text-gray-500">${item.weeks[4] || '-'}</td>
                    <td class="text-center text-gray-500">${item.weeks[5] || '-'}</td>
                    <td class="text-right font-bold text-blue-600">${item.total}</td>
                </tr>`;
            });
        }
    }

    // [New] Render Trend Chart
    window.renderTrendChart = function(endMonthStr) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        
        // Calculate last 6 months
        const labels = [];
        const data = [];
        
        // Parse "YYYY-MM"
        const [year, month] = endMonthStr.split('-').map(Number);
        let current = new Date(year, month - 1, 1); // Month is 0-indexed in Date

        for(let i=0; i<6; i++) {
            // Format YYYY-MM
            const y = current.getFullYear();
            const m = String(current.getMonth() + 1).padStart(2, '0');
            const key = `${y}-${m}`;
            
            labels.unshift(key); // Add to front
            
            // Count unique members for this month
            const count = new Set(logs.filter(l => l.date.startsWith(key)).map(l => l.memberId)).size;
            data.unshift(count);

            // Go back 1 month
            current.setMonth(current.getMonth() - 1);
        }

        if (trendChartInstance) {
            trendChartInstance.destroy();
        }

        trendChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ì›”ê°„ ì¶œì„ ì¸ì›',
                    data: data,
                    borderColor: '#4f46e5', // Indigo-600
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    borderWidth: 2,
                    tension: 0.3, // Smooth curve
                    fill: true,
                    pointBackgroundColor: '#ffffff',
                    pointBorderColor: '#4f46e5',
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { top: 25 } },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        display: true,
                        align: 'top',
                        anchor: 'end',
                        offset: 4,
                        color: '#4f46e5',
                        font: { weight: 'bold', size: 12 },
                        formatter: (value) => value > 0 ? value + 'ëª…' : ''
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y + 'ëª…';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grace: '15%',
                        ticks: { stepSize: 1 },
                        grid: { borderDash: [2, 4] }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // --- 5. QR & Paper Input Logic ---
    window.openQRPrintModal = function() {
        const container = document.getElementById('static-qr-list');
        container.innerHTML = '';
        const baseUrl = window.location.href.split('?')[0];
        SESSIONS.forEach(s => {
            const wrapper = document.createElement('div');
            wrapper.className = "border-2 border-dashed border-gray-300 p-6 rounded-xl flex flex-col items-center page-break-inside-avoid";
            const title = document.createElement('h3'); title.className = "text-xl font-bold mb-1"; title.innerText = s.name;
            const sub = document.createElement('p'); sub.className = "text-gray-500 mb-4"; sub.innerText = `${s.start}:00 ~ ${s.end}:00`;
            const qrDiv = document.createElement('div');
            const targetUrl = `${baseUrl}?session=${s.code}`;
            new QRCode(qrDiv, { text: targetUrl, width: 180, height: 180, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.M });
            wrapper.appendChild(title); wrapper.appendChild(sub); wrapper.appendChild(qrDiv); container.appendChild(wrapper);
        });
        document.getElementById('qr-print-modal').classList.remove('hidden');
    }
    window.closeQRPrintModal = function() { document.getElementById('qr-print-modal').classList.add('hidden'); }

    window.openPaperInputModal = function() {
        const modal = document.getElementById('paper-input-modal');
        document.getElementById('paper-date').value = new Date().toISOString().slice(0,10);
        updateSessionOptions();
        document.getElementById('paper-text-area').value = '';
        modal.classList.remove('hidden');
    }

    window.updateSessionOptions = function() {
        const dateStr = document.getElementById('paper-date').value;
        if(!dateStr) return;
        const date = new Date(dateStr);
        const day = date.getDay();
        const select = document.getElementById('paper-session-select');
        select.innerHTML = '';
        const availableSessions = SESSIONS.filter(s => s.day === day);
        if(availableSessions.length > 0) {
            availableSessions.forEach(s => {
                const opt = document.createElement('option'); opt.value = s.code; opt.innerText = s.name; select.appendChild(opt);
            });
        } else {
            const opt = document.createElement('option'); opt.innerText = "í•´ë‹¹ ìš”ì¼ì—” ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤."; select.appendChild(opt);
        }
    }

    window.closePaperInputModal = function() { document.getElementById('paper-input-modal').classList.add('hidden'); }

    window.processPaperInput = async function() {
        const dateStr = document.getElementById('paper-date').value;
        const sessionCode = document.getElementById('paper-session-select').value;
        const text = document.getElementById('paper-text-area').value;
        
        if(!dateStr) return alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        if(!sessionCode || sessionCode.startsWith("í•´ë‹¹")) return alert('ìœ íš¨í•œ ìˆ˜ì—…(ì°¨ìˆ˜)ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        if(!text.trim()) return alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        const session = SESSIONS.find(s => s.code === sessionCode);
        const lines = text.split(/[\n,]+/).map(n => n.trim()).filter(n => n.length > 0);
        
        let successCount = 0; let newMemberCount = 0; let duplicateCount = 0;
        let successNames = [];
        
        const batch = writeBatch(db);
        let tempMembers = [...members]; // Local cache for this batch operation
        const processedInBatch = new Set(); // To prevent duplicates within the same bulk input
        
        lines.forEach(line => {
            let inputName = line; let inputPhone = null;
            const match = line.match(/^(.*?)[\s]+(\d{4})$/);
            if (match) { inputName = match[1].trim(); inputPhone = match[2]; }
            
            let candidates = tempMembers.filter(m => m.name === inputName);
            let targetMember = null;

            if (candidates.length === 0) {
                // Create new member ref
                const newMemberRef = doc(collection(db, "members"));
                const newMemberData = { name: inputName, phone: inputPhone || "0000" };
                batch.set(newMemberRef, newMemberData);
                
                targetMember = { id: newMemberRef.id, ...newMemberData };
                tempMembers.push(targetMember);
                newMemberCount++;
            } else if (candidates.length === 1) {
                if (inputPhone && candidates[0].phone !== "0000" && candidates[0].phone !== inputPhone) {
                    // Different person (same name, diff phone)
                    const newMemberRef = doc(collection(db, "members"));
                    const newMemberData = { name: inputName, phone: inputPhone };
                    batch.set(newMemberRef, newMemberData);
                    
                    targetMember = { id: newMemberRef.id, ...newMemberData };
                    tempMembers.push(targetMember);
                    newMemberCount++;
                } else {
                    targetMember = candidates[0];
                    if(targetMember.phone === "0000" && inputPhone) {
                        // Update phone number
                        batch.update(doc(db, "members", targetMember.id), { phone: inputPhone });
                        targetMember.phone = inputPhone;
                    }
                }
            } else {
                if (inputPhone) targetMember = candidates.find(m => m.phone === inputPhone);
                if (!targetMember && inputPhone) {
                    const newMemberRef = doc(collection(db, "members"));
                    const newMemberData = { name: inputName, phone: inputPhone };
                    batch.set(newMemberRef, newMemberData);
                    targetMember = { id: newMemberRef.id, ...newMemberData };
                    tempMembers.push(targetMember);
                    newMemberCount++;
                }
            }
            
            if (targetMember) {
                // Check logs in memory (since we have real-time sync)
                const alreadyExists = logs.some(l => l.memberId === targetMember.id && l.date === dateStr && l.sessionCode === sessionCode);
                const alreadyInBatch = processedInBatch.has(targetMember.id);
                if(alreadyExists || alreadyInBatch) {
                    duplicateCount++;
                } else {
                    const newLogRef = doc(collection(db, "logs"));
                    batch.set(newLogRef, {
                        memberId: targetMember.id, 
                        memberName: targetMember.name, 
                        date: dateStr, 
                        sessionCode: session.code, 
                        sessionName: session.name, 
                        timestamp: new Date().toLocaleString() + " (ëª…ë¶€ì…ë ¥)"
                    });
                    processedInBatch.add(targetMember.id);
                    successNames.push(targetMember.name);
                    successCount++;
                }
            }
        });
        
        await batch.commit();
        if (successCount > 0) {
            playSound();
            const namesStr = successNames.join(', ');
            alert(`âœ… ë“±ë¡ ì™„ë£Œ\nì¼ì: ${dateStr}\nì°¨ìˆ˜: ${session.name}\nì„±í•¨: ${namesStr}\n\n(ì´ ${successCount}ëª… ì²˜ë¦¬ / ì¤‘ë³µ ì œì™¸: ${duplicateCount}ëª… / ì‹ ê·œ ê°€ì…: ${newMemberCount}ëª…)`);
        } else {
            alert(`ì²˜ë¦¬í•  ìƒˆë¡œìš´ ëª…ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.\n(ì¤‘ë³µ ì œì™¸: ${duplicateCount}ëª…)`);
        }
        
        // ì…ë ¥ì°½ ì´ˆê¸°í™” (í™”ë©´ì€ ë‹«ì§€ ì•ŠìŒ)
        document.getElementById('paper-text-area').value = '';
    }

    // --- 6. Attendance Logic (Scan) ---
    window.checkUrlForScan = function(silent = false) {
        const params = new URLSearchParams(window.location.search);
        const sessionCode = params.get('session');
        
        // Clear session from URL immediately to prevent loops
        if (sessionCode) {
            history.replaceState({}, document.title, window.location.pathname);
        }

        if (sessionCode) {
            const session = SESSIONS.find(s => s.code === sessionCode);
            if (session) {
                const now = new Date();
                const isWrongDay = now.getDay() !== session.day;
                const isWrongTime = now.getHours() < session.start || now.getHours() >= session.end;
                
                if (!silent && (isWrongDay || isWrongTime)) {
                    const msg = isWrongDay ? `ì˜¤ëŠ˜ì€ ${DAYS[now.getDay()]}ìš”ì¼ì…ë‹ˆë‹¤.` : `í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ìˆ˜ì—… ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.`;
                    if(!confirm(`âš ï¸ QR ì •ë³´ì™€ í˜„ì¬ ì‹œê°„ì´ ë‹¤ë¦…ë‹ˆë‹¤.\n(${session.name})\n\nê·¸ë˜ë„ ì¶œì„ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        if (sessionStorage.getItem('isAdminLoggedIn') !== 'true') showLoginScreen();
                        return;
                    }
                }
                handleScan(session);
            } else {
                if (!silent) alert("ìœ íš¨í•˜ì§€ ì•Šì€ QR ì½”ë“œì…ë‹ˆë‹¤.");
                if (sessionStorage.getItem('isAdminLoggedIn') !== 'true') showLoginScreen();
            }
        }
    }
    window.handleScan = function(session, silent = false) {
        const now = new Date();
        const isWrongDay = now.getDay() !== session.day;
        const isWrongTime = now.getHours() < session.start || now.getHours() >= session.end;

        // Clear session from URL immediately to prevent loops
        history.replaceState({}, document.title, window.location.pathname);

        if (isWrongDay || isWrongTime) {
            if (!silent) {
                const msg = isWrongDay ? `ì˜¤ëŠ˜ì€ ${DAYS[now.getDay()]}ìš”ì¼ì…ë‹ˆë‹¤.` : `í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.`;
                alert(`âŒ ì¶œì„ ì‹¤íŒ¨\n${msg}`);
            }
            return;
        }
        currentScanSession = session;
        const modal = document.getElementById('user-check-modal');
        document.getElementById('scan-info').innerText = `[${session.name}]`;
        
        // Reset UI
        toggleCheckMode('manual'); // Set manual input as default
        document.getElementById('check-manual-name').value = '';
        document.getElementById('check-manual-phone').value = '';

        // [FIX] Don't populate list here. Just reset the selection.
        document.getElementById('check-user-select').value = '';
        modal.classList.remove('hidden');
    }

    window.toggleCheckMode = function(mode) {
        if (mode === 'manual') {
            document.getElementById('check-existing-wrapper').classList.add('hidden');
            document.getElementById('check-manual-wrapper').classList.remove('hidden');
        } else {
            document.getElementById('check-existing-wrapper').classList.remove('hidden');
            document.getElementById('check-manual-wrapper').classList.add('hidden');
        }
    }

    window.confirmAttendance = async function() {
        const isManual = !document.getElementById('check-manual-wrapper').classList.contains('hidden');
        let member = null;
        let isNewMember = false;

        if (isManual) {
            const name = document.getElementById('check-manual-name').value.trim();
            const phone = document.getElementById('check-manual-phone').value.trim() || "0000";
            if (!name) return alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            
            // [NEW] Find or Create Logic
            // 1. Try to find the member from the local list
            let candidates = window.members.filter(m => m.name === name);
            
            if (phone !== "0000") {
                // If phone is provided, find an exact match
                member = candidates.find(m => m.phone === phone);
            } else if (candidates.length === 1) {
                // If no phone is provided and there's only one person with that name
                member = candidates[0];
            } else if (candidates.length > 1) {
                return alert(`ë™ëª…ì´ì¸(${name})ì´ ìˆìŠµë‹ˆë‹¤. ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ë¥¼ ì…ë ¥í•˜ì—¬ êµ¬ë¶„í•´ì£¼ì„¸ìš”.`);
            }

            // 2. If not found, create a new one
            if (!member) {
                try {
                    const docRef = await addDoc(collection(db, "members"), { name, phone });
                    member = { id: docRef.id, name, phone };
                    isNewMember = true;
                } catch (e) {
                    console.error(e);
                    return alert("íšŒì› ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            }
        } else {
            const memberId = document.getElementById('check-user-select').value;
            if(!memberId) return alert('íšŒì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            member = members.find(m => m.id === memberId);
        }

        await confirmAttendanceWithId(member?.id, isNewMember);
    }

    window.confirmAttendanceWithId = async function(memberId, isNewMember = false, manualDate = null, manualSessionCode = null) {
        const member = members.find(m => m.id === memberId);
        if (!member) return alert('íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

        const dateStr = manualDate || document.getElementById('check-date').value;
        const sessionCode = manualSessionCode || document.getElementById('check-session-select').value;
        const session = SESSIONS.find(s => s.code === sessionCode);
        
        if(!session) return alert('ìœ íš¨í•œ ìˆ˜ì—…(ì°¨ìˆ˜)ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');

        const alreadyChecked = logs.some(log => log.memberId === member.id && log.date === dateStr && log.sessionCode === session.code);
        
        if(alreadyChecked) alert('âš ï¸ ì´ë¯¸ ì¶œì„ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        else {
            await addDoc(collection(db, "logs"), {
                memberId: member.id, 
                memberName: member.name, 
                date: dateStr, 
                sessionCode: session.code, 
                sessionName: session.name, 
                timestamp: new Date().toLocaleString()
            });
            playSound();
            let message = `âœ… ${member.name}ë‹˜ ì¶œì„ ì™„ë£Œ!`;
            if (isNewMember) {
                message += ' (ì‹ ê·œ íšŒì›ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤)';
            }
            alert(message);
        }
        closeCheckModal();
        document.getElementById('member-search-input').value = '';
        renderMemberGrid();
    }
    window.closeCheckModal = function() {
        document.getElementById('user-check-modal').classList.add('hidden');
        history.replaceState({}, document.title, window.location.pathname);
        if (sessionStorage.getItem('isAdminLoggedIn') !== 'true') showLoginScreen();
    }

    // --- 7. History Modal Logic ---
    window.openHistoryModal = function(memberId) {
        const member = members.find(m => m.id === memberId);
        if(!member) return;
        document.getElementById('history-member-name').innerText = `${member.name} ë‹˜ì˜ ì¶œì„ ì´ë ¥`;
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        const history = logs.filter(l => l.memberId === memberId).sort((a, b) => b.id - a.id);
        if(history.length === 0) {
            list.innerHTML = '<li class="text-center text-gray-400 py-4">ì¶œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
        } else {
            history.forEach(h => {
                list.innerHTML += `<li class="bg-gray-50 p-3 rounded border border-gray-100"><div class="flex justify-between items-center mb-1"><span class="font-bold text-gray-700">${h.date}</span><span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded">${h.sessionName}</span></div><div class="text-xs text-gray-400 text-right">${h.timestamp}</div></li>`;
            });
        }
        document.getElementById('history-modal').classList.remove('hidden');
    }
    window.closeHistoryModal = function() { document.getElementById('history-modal').classList.add('hidden'); }

    // --- [NEW] Session Attendees Modal Logic ---
    window.openSessionAttendeesModal = function(sessionName, week) { // week is 1-5, or null for total
        const selectedMonth = document.getElementById('report-month').value;
        
        let sessionLogs = logs.filter(log => 
            log.date.startsWith(selectedMonth) && log.sessionName === sessionName
        );

        let subtitle;
        if (week) {
            sessionLogs = sessionLogs.filter(log => getWeekOfMonth(log.date) === week);
            subtitle = `${selectedMonth}ì›” / ${week}ì£¼ì°¨`;
        } else {
            subtitle = `${selectedMonth}ì›” / ì „ì²´`;
        }

        const attendees = [...new Set(sessionLogs.map(log => log.memberName))].sort((a, b) => a.localeCompare(b));

        document.getElementById('session-attendees-title').innerText = `[${sessionName}] ì°¸ì„ì`;
        document.getElementById('session-attendees-subtitle').innerText = `${subtitle} / ì´ ${attendees.length}ëª… (ì¤‘ë³µì œì™¸)`;
        
        const list = document.getElementById('session-attendees-list');
        list.innerHTML = '';

        if (attendees.length === 0) {
            list.innerHTML = '<li class="text-center text-gray-400 py-4">ì°¸ì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
        } else {
            attendees.forEach(name => list.innerHTML += `<li class="bg-gray-50 p-2 rounded">${name}</li>`);
        }
        document.getElementById('session-attendees-modal').classList.remove('hidden');
    }
    window.closeSessionAttendeesModal = function() { document.getElementById('session-attendees-modal').classList.add('hidden'); }

    // --- 8. Common Functions ---
    window.addMember = async function() {
        const name = document.getElementById('new-member-name').value;
        let phone = document.getElementById('new-member-phone').value;
        if (!name) return alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        if (!phone) phone = "0000";

        // [NEW] Duplicate Check
        const isDuplicate = members.some(m => m.name === name && m.phone === phone);
        if (isDuplicate) {
            return alert(`âš ï¸ ì´ë¯¸ ë“±ë¡ëœ íšŒì›ì…ë‹ˆë‹¤.\n(ì´ë¦„: ${name}, ë²ˆí˜¸: ${phone})`);
        }
        
        await addDoc(collection(db, "members"), { name, phone });
        document.getElementById('new-member-name').value = ''; document.getElementById('new-member-phone').value = '';
        alert('íšŒì›ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    window.renderMembers = function() {
        const list = document.getElementById('member-list');
        document.getElementById('member-count').innerText = `(${members.length}ëª…)`;
        list.innerHTML = '';
        members.forEach(m => {
            list.innerHTML += `<li class="py-3 flex justify-between items-center"><div onclick="openHistoryModal('${m.id}')" class="cursor-pointer flex-1 hover:bg-gray-50 p-1 rounded transition"><p class="font-bold text-gray-800 flex items-center">${m.name} <i class="fas fa-chevron-right text-gray-300 text-xs ml-2"></i></p><p class="text-xs text-gray-400">${m.phone}</p></div><button onclick="deleteMember('${m.id}')" class="text-red-400 text-xs border border-red-200 px-2 py-1 rounded hover:bg-red-50 ml-2">ì‚­ì œ</button></li>`;
        });
    }
    
    window.deleteMember = async function(id) {
        const hasHistory = logs.some(log => log.memberId === id);
        if (hasHistory) {
            alert("âŒ ì‚­ì œ ì‹¤íŒ¨\nì´ íšŒì›ì˜ ì¶œì„ ê¸°ë¡ì´ ì¡´ì¬í•©ë‹ˆë‹¤.\nê¸°ë¡ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const isAuthorized = await requestPassword();
        if (!isAuthorized) return;

        if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            await deleteDoc(doc(db, "members", id));
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    window.resetData = async function() { 
        const isAuthorized = await requestPassword();
        if (!isAuthorized) return;

        const input = prompt('âš ï¸ ë°ì´í„° ì´ˆê¸°í™” ìµœì¢… ê²½ê³  âš ï¸\n\nëª¨ë“  íšŒì› ì •ë³´ì™€ ì¶œì„ ê¸°ë¡ì´ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nì‚­ì œí•˜ë ¤ë©´ "ì´ˆê¸°í™”" ë¼ê³  ì…ë ¥í•˜ì„¸ìš”.');
        
        if(input === "ì´ˆê¸°í™”") { 
            const batch = writeBatch(db);
            members.forEach(m => batch.delete(doc(db, "members", m.id)));
            logs.forEach(l => batch.delete(doc(db, "logs", l.id)));
            await batch.commit();
            alert("ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload(); 
        } else if (input !== null) {
            alert("ì…ë ¥ê°’ì´ ì¼ì¹˜í•˜ì§€ ì•Šì•„ ì´ˆê¸°í™”ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    }

    // --- [NEW] Password Confirmation Modal Logic ---
    let passwordResolve = null;
    window.requestPassword = function() {
        const lockout = JSON.parse(localStorage.getItem('adminLockout') || '{"attempts":0, "until":0}');
        const now = Date.now();
        if (now < lockout.until) {
            const remaining = Math.ceil((lockout.until - now) / 1000);
            alert(`ğŸ” ë³´ì•ˆ ì œí•œ: ë¹„ë°€ë²ˆí˜¸ë¥¼ ì—¬ëŸ¬ ë²ˆ í‹€ë ¤ ì‹œë„ê°€ ì œí•œë˜ì—ˆìŠµë‹ˆë‹¤.\n${remaining}ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
            return Promise.resolve(false);
        }

        return new Promise((resolve) => {
            passwordResolve = resolve;
            const modal = document.getElementById('password-confirm-modal');
            const input = document.getElementById('confirm-pw-input');
            input.value = '';
            modal.classList.remove('hidden');
            input.focus();
        });
    };

    window.handlePasswordConfirm = function() {
        const input = document.getElementById('confirm-pw-input');
        const pw = input.value.trim();
        const storedPw = (localStorage.getItem('adminPassword') || '1234').trim();
        let lockout = JSON.parse(localStorage.getItem('adminLockout') || '{"attempts":0, "until":0}');

        if (pw === storedPw) {
            localStorage.setItem('adminLockout', JSON.stringify({attempts: 0, until: 0}));
            document.getElementById('password-confirm-modal').classList.add('hidden');
            if (passwordResolve) passwordResolve(true);
        } else {
            lockout.attempts++;
            if (lockout.attempts >= 5) {
                lockout.until = Date.now() + 60000; // 1ë¶„ ì°¨ë‹¨
                lockout.attempts = 0;
                localStorage.setItem('adminLockout', JSON.stringify(lockout));
                alert('âŒ ë¹„ë°€ë²ˆí˜¸ë¥¼ 5íšŒ ì—°ì† í‹€ë ¸ìŠµë‹ˆë‹¤.\në³´ì•ˆì„ ìœ„í•´ 1ë¶„ê°„ ì¬ì‹œë„ê°€ ì œí•œë©ë‹ˆë‹¤.');
                closePasswordConfirmModal();
            } else {
                localStorage.setItem('adminLockout', JSON.stringify(lockout));
                alert(`âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. (í‹€ë¦° íšŸìˆ˜: ${lockout.attempts}/5)`);
                input.value = '';
                input.focus();
            }
        }
    };

    window.closePasswordConfirmModal = function() {
        document.getElementById('password-confirm-modal').classList.add('hidden');
        if (passwordResolve) passwordResolve(false);
    };

    // --- 9. Sound Effects ---
    let audioCtx;
    function playSound() {
        if (!audioCtx) {
            try {
                // Safari requires webkit prefix
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.error("Web Audio API is not supported in this browser.");
                return;
            }
        }
        
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.type = 'sine'; // A clean, pleasant tone
        oscillator.frequency.setValueAtTime(1046.50, audioCtx.currentTime); // C6 Note for a "ding"

        gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.05); // Quick fade-in to prevent click
        gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.3); // Fade-out

        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.3);
    }

    window.switchPage = function(element, pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        element.classList.add('active');
        if(pageId === 'reports') renderReports();
    }

    // --- 11. Password Management ---
    window.openPasswordChangeModal = function() {
        document.getElementById('current-password').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-password').value = '';
        document.getElementById('password-change-modal').classList.remove('hidden');
    }
    
    window.closePasswordChangeModal = function() {
        document.getElementById('password-change-modal').classList.add('hidden');
    }

    window.changePassword = function() {
        const currentPw = document.getElementById('current-password').value.trim();
        const newPw = document.getElementById('new-password').value.trim();
        const confirmPw = document.getElementById('confirm-password').value.trim();
        const storedPw = (localStorage.getItem('adminPassword') || '1234').trim();

        if (currentPw !== storedPw) return alert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        if (newPw.length < 4) return alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        if (newPw !== confirmPw) return alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');

        localStorage.setItem('adminPassword', newPw);
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        closePasswordChangeModal();
    }

    // --- 10. App Initialization & Login ---
    window.showLoginScreen = function() {
        document.getElementById('start-screen').classList.remove('hidden');
        document.getElementById('app-main-content').classList.add('hidden');
    }

    window.showAdminLogin = function() {
        document.getElementById('mode-selection').classList.add('hidden');
        document.getElementById('login-form').classList.remove('hidden');
        document.getElementById('admin-password').focus();
    }

    window.backToModeSelection = function() {
        document.getElementById('mode-selection').classList.remove('hidden');
        document.getElementById('login-form').classList.add('hidden');
    }

    window.enterMemberMode = function() {
        sessionStorage.setItem('appMode', 'member');
        showApp();
    }

    window.exitMemberMode = function() {
        sessionStorage.removeItem('appMode');
        sessionStorage.removeItem('isAdminLoggedIn');
        location.reload();
    }

    window.showApp = function() {
        const mode = sessionStorage.getItem('appMode') || (sessionStorage.getItem('isAdminLoggedIn') === 'true' ? 'admin' : null);
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('app-main-content').classList.remove('hidden');
        
        if (mode === 'member') {
            document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
            document.getElementById('btn-exit-member-mode').classList.remove('hidden');
            switchPage(null, 'member-attendance');
            
            // Initialize Member Mode Inputs
            const todayStr = new Date().toISOString().slice(0,10);
            document.getElementById('member-mode-date').value = todayStr;
            updateMemberModeSessionOptions();
            
            const session = getCurrentSession();
            document.getElementById('current-session-info').innerText = session ? `í˜„ì¬ ìˆ˜ì—…: ${session.name}` : "í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.";
            if (session) document.getElementById('member-mode-session').value = session.code;

            renderMemberGrid(); // ëª…ë‹¨ ê·¸ë¦¬ë“œ ê°•ì œ ë Œë”ë§
        } else {
            document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
            document.getElementById('btn-exit-member-mode').classList.add('hidden');
            // ê´€ë¦¬ì ëª¨ë“œì¼ ë•ŒëŠ” í™ˆ í˜ì´ì§€ë¡œ ì´ë™ (ì•ˆì „í•˜ê²Œ ì²« ë²ˆì§¸ ë©”ë‰´ ì„ íƒ)
            const firstNavItem = document.querySelector('.nav-item');
            if (firstNavItem) switchPage(firstNavItem, 'home');
        }

        // Run initial setup that requires the DOM to be visible
        if (document.getElementById('current-url')) {
            document.getElementById('current-url').innerText = window.location.href.split('?')[0];
        }
        checkUrlForScan();
    }

    window.handleLogin = function() {
        const passwordField = document.getElementById('admin-password');
        const password = passwordField.value.trim();
        
        if (!password) return; 

        const storedPw = (localStorage.getItem('adminPassword') || '1234').trim();

        if (password === storedPw) {
            sessionStorage.setItem('isAdminLoggedIn', 'true');
            sessionStorage.setItem('appMode', 'admin');
            showApp();
        } else {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
            passwordField.value = '';
            passwordField.focus();
        }
    }

    window.togglePasswordVisibility = function(checkbox) {
        const passwordField = document.getElementById('admin-password');
        passwordField.type = checkbox.checked ? 'text' : 'password';
    }

    // ì•± ì´ˆê¸°í™” ì‹¤í–‰
    (function init() {
        const urlParams = new URLSearchParams(window.location.search);
        const isScanning = urlParams.has('session');
        
        const savedMode = sessionStorage.getItem('appMode');
        const isAdminLoggedIn = sessionStorage.getItem('isAdminLoggedIn') === 'true';

        if (savedMode === 'member') {
            showApp();
        } else if (savedMode === 'admin' && isAdminLoggedIn) {
            showApp();
        } else if (isScanning) {
            sessionStorage.setItem('appMode', 'member');
            showApp();
        }
        else showLoginScreen();
    })();
</script>
</body>
</html>
